---
title: HoloLens (1-й общий) и Azure 307 — машинное обучение
description: Пройдите этот курс, чтобы узнать, как реализовать Машинное обучение Azure Studio (классическая модель) в приложении смешанной реальности.
author: drneil
ms.author: jemccull
ms.date: 07/04/2018
ms.topic: article
keywords: Azure, Mixed Reality, Academy, Unity, учебник, API, машинное обучение, ML, студия машинного обучения, hololens, иммерсивное, VR, Windows 10, Visual Studio
ms.openlocfilehash: c9d6408d41340b1c0fcb1f41b61d84ba115258c3
ms.sourcegitcommit: 35bd43624be33afdb1bf6ba4ddbe36d268eb9bda
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "104730521"
---
# <a name="hololens-1st-gen-and-azure-307-machine-learning"></a>HoloLens (1-й общий) и Azure 307: машинное обучение

<br>

>[!NOTE]
>Руководства Mixed Reality Academy были разработаны для иммерсивных гарнитур HoloLens (1-го поколения) и иммерсивных гарнитур Mixed Reality.  Поэтому мы считаем, что важно оставить эти руководства для разработчиков, которые ищут рекомендации по разработке для этих устройств.  Данные руководства **_не_** будут обновляться с учетом последних наборов инструментов или возможностей взаимодействия для HoloLens 2.  Они будут сохранены для работы на поддерживаемых устройствах. Появится новая серия руководств, которые будут опубликованы в будущем, где будет показано, как разрабатывать данные для HoloLens 2.  Это уведомление будет обновлено ссылкой на эти учебники при их публикации.

<br>

![окончательный продукт — запуск](images/AzureLabs-Lab7-0.png)

В этом курсе вы узнаете, как добавить возможности Машинное обучение (машинного обучения) в приложение смешанной реальности с помощью Машинное обучение Azure Studio (классическая модель).

*Машинное обучение Azure Studio (классическая модель)* — это служба Майкрософт, которая предоставляет разработчикам большое количество алгоритмов машинного обучения, которые могут помочь в вводе, выводе, подготовке и визуализации данных. После этих компонентов можно разработать эксперимент прогнозной аналитики, выполнить его итерацию и использовать для обучения модели. После обучения можно сделать модель рабочей в облаке Azure, чтобы она могла затем оценить новые данные. Дополнительные сведения см. на [странице машинное обучение Azure Studio (классическая модель)](https://azure.microsoft.com/services/machine-learning-studio/).

Прополнив этот курс, вы получите иммерсивное приложение для наушников смешанной реальности и узнаете, как сделать следующее:

1.  Предоставьте таблицу данных о продажах на портале *машинное обучение Azure Studio (классический)* и создайте алгоритм для прогнозирования будущих продаж популярных элементов.
2.  Создайте **проект Unity**, который может принимать и интерпретировать данные прогноза из службы ml.
3.  Визуально отображать данные затенения в **проекте Unity**, предоставляя наиболее популярные элементы продаж на полке.

В приложении вы будете выполнять интеграцию результатов с вашей структурой. Этот курс предназначен для изучения того, как интегрировать службу Azure с проектом Unity. Это ваша задача использовать знания, полученные из этого курса, для улучшения приложения смешанной реальности.

Этот курс является автономным учебником, который не участвует в других практических занятиях смешанной реальности.

## <a name="device-support"></a>Поддержка устройств

<table>
<tr>
<th>Курс</th><th style="width:150px"> <a href="/hololens/hololens1-hardware">HoloLens</a></th><th style="width:150px"> <a href="../../../discover/immersive-headset-hardware-details.md">Иммерсивные гарнитуры</a></th>
</tr><tr>
<td> 307. Смешанная реальность и Azure: машинное обучение</td><td style="text-align: center;"> ✔️</td><td style="text-align: center;"> ✔️</td>
</tr>
</table>

> [!NOTE]
> Хотя этот курс в основном ориентирован на гарнитуры Windows Mixed Reality (VR), вы также можете применить сведения, которые вы узнаете в этом курсе, к Microsoft HoloLens. Как вы пройдете вместе с курсом, вы увидите примечания о любых изменениях, которые могут потребоваться для поддержки HoloLens. При использовании HoloLens вы можете заметить некоторые эхо во время записи голоса.

## <a name="prerequisites"></a>Предварительные требования

> [!NOTE]
> Этот учебник предназначен для разработчиков, имеющих базовый опыт работы с Unity и C#. Также имейте в виду, что предварительные требования и письменные инструкции в этом документе отражают, что проверялось и проверено во время написания статьи (Май 2018). Вы можете использовать новейшее программное обеспечение, как указано в [статье Установка средств](../../install-the-tools.md), но не следует предполагать, что информация в этом курсе будет полностью соответствовать тому, что вы найдете в более новом программном обеспечении, чем показано ниже.

Для этого курса рекомендуется следующее оборудование и программное обеспечение:

- ПК для разработки, [совместимый с Windows Mixed Reality](https://support.microsoft.com/help/4039260/windows-10-mixed-reality-pc-hardware-guidelines) для разработки головных телефонов (VR)
- [Windows 10 для дизайнеров с обновлением (или более поздней версии) с включенным режимом разработчика](../../install-the-tools.md#installation-checklist)
- [Последний пакет SDK для Windows 10](../../install-the-tools.md#installation-checklist)
- [Unity 2017,4](../../install-the-tools.md#installation-checklist)
- [Visual Studio 2017](../../install-the-tools.md#installation-checklist)
- Высокодоступная [гарнитура Windows Mixed Reality (VR)](../../../discover/immersive-headset-hardware-details.md) или [Microsoft HoloLens](/hololens/hololens1-hardware) с включенным режимом разработчика
- Доступ к Интернету для установки Azure и получения данных машинного обучения

## <a name="before-you-start"></a>Перед началом работы

Чтобы избежать проблем при создании этого проекта, настоятельно рекомендуется создать проект, упомянутый в этом руководстве, в корневой или ближайшем к корневой папке (длинные пути к папкам могут вызвать проблемы во время сборки). 

## <a name="chapter-1---azure-storage-account-setup"></a>Глава 1. Настройка учетной записи хранения Azure

Чтобы использовать API-интерфейс Azure Translator, необходимо настроить экземпляр службы, чтобы сделать его доступным для приложения.
1.  Войдите на  [портал Azure](https://portal.azure.com).

    > [!NOTE]
    > Если у вас еще нет учетной записи Azure, необходимо создать ее. Если вы используете этот учебник в учебной или лабораторной ситуации, обратитесь к своему преподавателю или к одной из прокторс, чтобы получить помощь в настройке новой учетной записи.

2.  После входа в меню слева щелкните **учетные записи хранения** .

    ![Настройка учетной записи хранения Azure](images/AzureLabs-Lab7-1.png)

    > [!NOTE]
    > Слово **New** может быть заменено на **создать ресурс** в новых порталах.

3.  На вкладке **учетные записи хранения** щелкните **Добавить**.

    ![Настройка учетной записи хранения Azure](images/AzureLabs-Lab7-2.png)

4.  На панели **Создание учетной записи хранения** выполните следующие действия.

    1.  Введите **имя** для своей учетной записи. Имейте в виду, что это поле принимает только цифры и строчные буквы.
    2.  В качестве **модели развертывания** выберите **Resource Manager**.
    3.  В качестве **типа учетной записи** выберите **хранилище (общее назначение v1)**.
    4.  В разделе **Производительность** выберите **Стандартная**.
    5.  Для **репликации** выберите **геоизбыточное хранилище (RA-GRS) с доступом для чтения**.
    6.  Оставьте **защищенное перемещение обязательным** , как **отключено**.
    7.  Выберите **подписку**.
    4. Выберите **группу ресурсов** или создайте новую. Группа ресурсов предоставляет способ мониторинга, контроля доступа, подготовки счетов и управления ими для коллекции ресурсов Azure. Рекомендуется, чтобы все службы Azure, связанные с одним проектом (например, в этих лабораториях), были в общей группе ресурсов.

        > Если вы хотите ознакомиться с дополнительными сведениями о группах ресурсов Azure, обратитесь [к статье о группе ресурсов](/azure/azure-resource-manager/resource-group-portal).
    
    5.  Определите **Расположение** группы ресурсов (при создании новой группы ресурсов). В идеале это расположение будет находиться в регионе, в котором будет выполняться приложение. Некоторые ресурсы Azure доступны только в определенных регионах.

5.  Также необходимо подтвердить, что вы поняли условия, примененные к этой службе.

    ![Настройка учетной записи хранения Azure](images/AzureLabs-Lab7-3.png)

6.  После нажатия кнопки **создать** необходимо подождать, пока не будет создана служба, а это может занять некоторое время.

7.  После создания экземпляра службы на портале отобразится уведомление.

    ![Настройка учетной записи хранения Azure](images/AzureLabs-Lab7-4.png)

## <a name="chapter-2---the-azure-machine-learning-studio--classic"></a>Глава 2-Машинное обучение Azure Studio (классическая модель)

Чтобы использовать *машинное обучение Azure*, необходимо настроить экземпляр службы машинное обучение, чтобы сделать ее доступной для приложения.

1.  На портале Azure щелкните **создать** в левом верхнем углу и найдите **рабочую область машинное обучение Studio** и нажмите клавишу **Ввод**.

    ![Машинное обучение Azure Studio (классическая модель)](images/AzureLabs-Lab7-5.png)

2.  На новой странице будет представлено описание службы **рабочей области машинное обучение Studio**  . В нижнем левом углу этого запроса нажмите кнопку " **создать** ", чтобы создать связь с этой службой.

3.  После нажатия кнопки **создать** появится панель, где необходимо указать некоторые сведения о новой **службе машинное обучение Studio**:

    1.  Вставьте имя нужной **рабочей области** для этого экземпляра службы.

    2.  Выберите **подписку**.

    3. Выберите **группу ресурсов** или создайте новую. Группа ресурсов предоставляет способ мониторинга, контроля доступа, подготовки счетов и управления ими для коллекции ресурсов Azure. Рекомендуется, чтобы все службы Azure, связанные с одним проектом (например, в этих лабораториях), были в общей группе ресурсов. 

        > Если вы хотите ознакомиться с дополнительными сведениями о группах ресурсов Azure, обратитесь [к статье о группе ресурсов](/azure/azure-resource-manager/resource-group-portal).

    4.  Определите **Расположение** группы ресурсов (при создании новой группы ресурсов). В идеале это расположение будет находиться в регионе, в котором будет выполняться приложение. Некоторые ресурсы Azure доступны только в определенных регионах. Вы должны использовать ту же группу ресурсов, которая использовалась для создания хранилища Azure, в предыдущей главе.

    5.  В разделе **учетная запись хранения** щелкните **использовать существующий**, а затем в раскрывающемся меню выберите **учетную запись хранения** , созданную в последней главе.

    6.  Выберите нужную **ценовую категорию рабочей области** в раскрывающемся меню.

    7.  В разделе " **план веб-службы** " щелкните **создать** **,** а затем вставьте в текстовое поле имя.

    8.  В разделе **ценовая категория плана веб-службы** Выберите ценовую категорию по своему усмотрению. Уровень тестирования разработки под названием **DEVTEST Standard** должен быть доступен бесплатно.

    9.  Также необходимо подтвердить, что вы поняли условия, примененные к этой службе.

    10. Нажмите кнопку **Создать**.

        ![Машинное обучение Azure Studio (классическая модель)](images/AzureLabs-Lab7-6.png)

4.  После нажатия кнопки **создать** необходимо подождать, пока не будет создана служба, а это может занять некоторое время.

5.  После создания экземпляра службы на портале отобразится уведомление.

    ![Машинное обучение Azure Studio (классическая модель)](images/AzureLabs-Lab7-7.png)

6.  Щелкните уведомление, чтобы просмотреть новый экземпляр службы.

    ![Машинное обучение Azure Studio (классическая модель)](images/AzureLabs-Lab7-8.png)

7.  Нажмите кнопку " **Переход к ресурсу** " в уведомлении, чтобы изучить новый экземпляр службы.

8.  На отображаемой странице в разделе **Дополнительные ссылки** щелкните **запустить машинное обучение Studio**, чтобы браузер нанаправлялся на портал **машинное обучение Studio** .

    ![Машинное обучение Azure Studio (классическая модель)](images/AzureLabs-Lab7-9.png)

9.  Чтобы войти в Машинное обучение Studio (классическая модель), используйте кнопку **входа** в правом верхнем углу или в центре.

    ![Машинное обучение Azure Studio (классическая модель)](images/AzureLabs-Lab7-10.png)


## <a name="chapter-3---the-machine-learning-studio-classic-dataset-setup"></a>Глава 3-Машинное обучение Studio (классическая модель): Настройка набора данных

Одним из способов работы алгоритмов Машинное обучение является анализ существующих данных и последующая попытка прогнозировать будущие результаты на основе существующего набора данных. Как правило, это означает, что чем больше существующих данных, тем лучше алгоритм будет прогнозировать будущие результаты.

Для этого курса предоставляется пример таблицы с именем Продуктстаблексв, который [можно скачать здесь](https://github.com/Microsoft/HolographicAcademy/raw/Azure-MixedReality-Labs/Azure%20Mixed%20Reality%20Labs/MR%20and%20Azure%20307%20-%20Machine%20learning/MR%20and%20Azure%20307%20-%20Machine%20learning.zip).

> [!IMPORTANT]
> Указанный zip-файл содержит как **продуктстаблексв** , так и **пакет unitypackage**, которые понадобятся в [главе 6](#chapter-6---importing-the-mlproducts-unity-package). Этот пакет также предоставляется в этой главе, но разделяются на CSV-файл.

Этот образец набора данных содержит запись наиболее популярных объектов в каждый час каждого дня года 2017.
        
![Машинное обучение Studio (классическая модель): Настройка набора данных](images/AzureLabs-Lab7-11.png)

Например, в день 1 из 2017 в 13:00-14:30 (час 13) наиболее производительный элемент был Salt и перца.

Этот образец таблицы содержит 9998 записей.

1.  Вернитесь на портал **машинное обучение Studio (классический)** и добавьте эту таблицу в качестве **набора данных** для вашего машинного обучения. Для этого нажмите кнопку **+ создать** в левом нижнем углу экрана.

    ![Машинное обучение Studio (классическая модель): Настройка набора данных](images/AzureLabs-Lab7-12.png)

2.  Раздел появится снизу, и в нем есть панель навигации слева. Щелкните **набор данных**, а затем справа от параметра **локальный файл**.

    ![Машинное обучение Studio (классическая модель): Настройка набора данных](images/AzureLabs-Lab7-13.png)

3.  Отправьте новый **набор данных** , выполнив следующие действия.

    1. Появится окно Отправка, где можно **Просмотреть** жесткий диск для нового набора данных.

        ![Машинное обучение Studio (классическая модель): Настройка набора данных](images/AzureLabs-Lab7-14.png)

    2.  После выбора и обратно в окне Отправка снимите флажок не потикать.

    3.  В текстовом поле ниже введите **ProductsTableCSV.csv** в качестве имени для набора данных (хотя он должен быть добавлен автоматически).

    4.  С помощью раскрывающегося меню **тип** выберите **универсальный CSV-файл с заголовком (CSV)**.

    5.  Нажмите кнопку с галочкой в правом нижнем углу окна отправки, и ваш **набор данных** будет отправлен.

## <a name="chapter-4---the-machine-learning-studio-classic-the-experiment"></a>Глава 4 — Машинное обучение Studio (классическая модель): эксперимент

Перед созданием системы машинного обучения необходимо создать эксперимент, чтобы проверить свою теорию данных. С результатами вы узнаете, требуются ли дополнительные данные или нет никакой корреляции между данными и возможным результатом.

Чтобы начать создание эксперимента, выполните следующие действия.

1.  Щелкните еще раз на кнопке **+ создать** в левом нижнем углу страницы, а затем щелкните **эксперимент**  >  **пустой эксперимент**.

    ![Машинное обучение Studio (классическая модель): эксперимент](images/AzureLabs-Lab7-15.png)

2.  Откроется новая страница с пустым экспериментом:

3.  На панели слева разверните **сохраненные наборы данных**  >  **Мои наборы** данных и перетащите **продуктстаблексв** на **холст эксперимента**.

    ![Машинное обучение Studio (классическая модель): эксперимент](images/AzureLabs-Lab7-16.png)

4.  На панели слева разверните узел **Преобразование данных**—  >  **пример и разбиение**. Затем перетащите элемент « **разбить данные** » на **холст эксперимента**. Элемент «разбиение данных» разделяет набор данных на две части. Одна часть, которая будет использоваться для обучения алгоритма машинного обучения. Вторая часть будет использоваться для вычисления точности создаваемого алгоритма.

    ![Машинное обучение Studio (классическая модель): эксперимент](images/AzureLabs-Lab7-17.png)

5.  На правой панели (если выбран элемент «разделение данных» на холсте) измените **долю строк в первом выходном наборе данных** на **0,7**. При этом данные будут разделены на две части, первая часть будет составлять 70% данных, а вторая часть будет состоять из оставшихся 30%. Чтобы обеспечить разбиение данных в случайном порядке, убедитесь, что флажок **случайная разбивка** остается установленным.

    ![Машинное обучение Studio (классическая модель): эксперимент](images/AzureLabs-Lab7-18.png)

6.  Перетащите соединение из базового элемента **продуктстаблексв** на холста в верхнюю часть элемента данных разбиения. Это приведет к подключению элементов и отправке выходного набора данных **продуктстаблексв** (данных) в данные разбиения.  

    ![Машинное обучение Studio (классическая модель): эксперимент](images/AzureLabs-Lab7-19.png)

7.  На панели **эксперименты** слева разверните узел **машинное обучение**  >  **обучение**. Перетащите элемент **обучение модели** в холст эксперимента. Холст должен выглядеть так же, как показано ниже.

    ![Машинное обучение Studio (классическая модель): эксперимент](images/AzureLabs-Lab7-20.png)

8.  Перетащите соединение в **верхнюю правую** часть элемента « **обучение модели** » из **нижнего левого** угла _ элемента «_ *разделить данные**». В модели обучения для обучения алгоритму будет использоваться первый 70%, разделенный на набор данных.

    ![Машинное обучение Studio (классическая модель): эксперимент](images/AzureLabs-Lab7-21.png)

9.  Выберите элемент **обучение модели** на холсте и на панели **свойства** (в правой части окна браузера) нажмите кнопку **Выбор столбца для запуска** .

10. В текстовом поле введите **Product** и нажмите клавишу **Ввод**. *продукт* будет установлен в качестве столбца для обучения прогнозов. После этого щелкните **такт** в правом нижнем углу, чтобы закрыть диалоговое окно выбора.

    ![Машинное обучение Studio (классическая модель): эксперимент](images/AzureLabs-Lab7-22.png)

11. Вы собираетесь обучить алгоритм **логистической регрессии с многоклассией** для прогнозирования наиболее проданного **продукта** на основе часа дня и даты. В этом документе нет сведений о различных алгоритмах, предоставляемых Машинное обучение Azure Studio, но вы можете узнать больше на [странице машинное обучение Algorithm Памятка по](/azure/machine-learning/studio/algorithm-cheat-sheet) .

12. На панели "элементы эксперимента" слева разверните узел **машинное обучение**  >  **инициализировать**  >  **классификацию** модели и перетащите элемент **логистической регрессии с многоклассовой** моделью на холст эксперимента.

13. Соедините выходные данные от нижней части **логистической регрессии класса** с верхним левым входом элемента **обучение модели** .

    ![Машинное обучение Studio (классическая модель): эксперимент](images/AzureLabs-Lab7-23.png)

14. В списке элементов эксперимента на панели слева разверните узел   >  **Оценка** машинное обучение и перетащите элемент **модель оценки** на холст.

15. Соедините выходные данные от нижней части **модели обучения** с верхним левым входом **модели оценки**.

16. Соедините правый нижний вывод из раздела " **разбить данные**" к верхнему правому входу элемента **модели оценки** .

    ![Машинное обучение Studio (классическая модель): эксперимент](images/AzureLabs-Lab7-24.png)

17. В списке элементов **эксперимента** на панели слева разверните **машинное обучение**  >  **оценить** и перетащите элемент **Оценка модели** на холст.

18. Соедините выходные данные **модели оценки** с верхним левым входом **модели Evaluate**.

    ![Машинное обучение Studio (классическая модель): эксперимент](images/AzureLabs-Lab7-25.png)

19. Вы создали первый Машинное обучение эксперимент. Теперь можно сохранить и запустить эксперимент. В меню в нижней части страницы нажмите кнопку **сохранить** , чтобы сохранить эксперимент, а затем нажмите кнопку **выполнить** , чтобы запустить эксперимент.

    ![Машинное обучение Studio (классическая модель): эксперимент](images/AzureLabs-Lab7-26.png)

20. **Состояние** эксперимента можно увидеть в правом верхнем углу холста. Подождите некоторое время, пока эксперимент завершится.

    > Если у вас есть большой набор данных (реальный мир), скорее всего, для выполнения эксперимента может потребоваться несколько часов.

    ![Машинное обучение Studio (классическая модель): эксперимент](images/AzureLabs-Lab7-27.png)

21. Щелкните правой кнопкой мыши элемент **Оценка модели** на холсте и в контекстном меню наведите указатель мыши на **результаты оценки**, а затем выберите **визуализировать**.

    ![Машинное обучение Studio (классическая модель): эксперимент](images/AzureLabs-Lab7-28.png)

22. Результаты оценки будут отображаться, отображая прогнозируемые результаты и фактические результаты. В этом случае используется 30% исходного набора данных, который был разделен ранее для оценки модели. Результаты могут быть небольшими, в идеале в каждой строке будет выделено выделенный элемент в столбцах.

    ![Машинное обучение Studio (классическая модель): эксперимент](images/AzureLabs-Lab7-29.png)

23. Закройте **результаты**.

24. Чтобы использовать новую обученную модель Машинное обучение необходимо предоставить ее в качестве **веб-службы**. Для этого щелкните элемент меню **Настройка веб-службы** в меню в нижней части страницы и щелкните **прогнозная веб-служба**.

    ![Машинное обучение Studio (классическая модель): эксперимент](images/AzureLabs-Lab7-30.png)

25. Будет создана новая вкладка, а также Объединенная модель для создания новой веб-службы. 

26. В меню в нижней части страницы щелкните **сохранить**, а затем — **выполнить**. Вы увидите состояние Обновлено в правом верхнем углу холста эксперимента.

    ![Машинное обучение Studio (классическая модель): эксперимент](images/AzureLabs-Lab7-31.png)

27. После завершения работы в нижней части страницы появится кнопка **развернуть веб-службу** . Все готово для развертывания веб-службы. Щелкните **развернуть веб-службу** (классическая) в меню в нижней части страницы.

    ![Машинное обучение Studio (классическая модель): эксперимент](images/AzureLabs-Lab7-32.png)

    > В браузере может появиться запрос на разрешение всплывающего окна, которое следует **Разрешить**, хотя может потребоваться еще раз нажать кнопку **развернуть веб-службу** , если страница развертывание не отображается. 

28. После создания эксперимента вы будете перенаправлены на страницу **панели мониторинга** , где будет отображаться **ключ API** . Скопируйте его в блокноте. в этот момент он понадобится в коде очень быстро. После того как вы заметили ключ API, нажмите кнопку **запрос/ответ** в разделе **Конечная точка по умолчанию** под ключом.

    ![Машинное обучение Studio (классическая модель): эксперимент](images/AzureLabs-Lab7-33.png)

    > [!NOTE] 
    > Если нажать кнопку Тест на этой странице, можно будет ввести входные данные и просмотреть результат. Введите **день** и **час**. Оставьте поле ввода **продукта** пустым. Затем нажмите кнопку **Confirm (подтвердить** ). В выходных данных в нижней части страницы будет показан код JSON, представляющий вероятность выбора каждого продукта.

29. Откроется новая веб-страница, в которой будут показаны инструкции и некоторые примеры структуры запроса, необходимой для Машинное обучение Studio (классической). Скопируйте **URI запроса** , показанный на этой странице, в Блокнот.

    ![Машинное обучение Studio (классическая модель): эксперимент](images/AzureLabs-Lab7-34.png)

Теперь вы создали систему машинного обучения, которая предоставляет наиболее вероятный продукт для продажи на основе исторических данных о покупках, сопоставленных с временем дня и дня года.

Для вызова веб-службы вам потребуется URL-адрес конечной точки службы и ключ API для службы. Откройте вкладку **Использование** , расположенную в верхнем меню.

На странице сведения о **потреблении** будут отображены сведения, необходимые для вызова веб-службы из кода. Сделайте копию **первичного ключа** и URL-адреса **запроса и ответа** . Они понадобятся в следующей главе.

## <a name="chapter-5---setting-up-the-unity-project"></a>Глава 5. Настройка проекта Unity

Настройка и тестирование иммерсивного наушников смешанной реальности.

> [!NOTE]
>  Для этого курса **не** потребуется использовать контроллеры движения. Если вам нужна поддержка настройки иммерсивного головного телефона, щелкните [здесь](https://support.microsoft.com/help/4043101/windows-10-set-up-windows-mixed-reality).

1.  Откройте **Unity** и создайте новый проект Unity с именем **MR \_ MachineLearning.** Убедитесь, что для типа проекта задано значение **3D**.

2.  При открытом Unity стоит проверить, что для **редактора скриптов** по умолчанию задано значение **Visual Studio**. Перейдите к разделу **изменение**  >  **настроек** , а затем в новом окне перейдите к разделу **Внешние инструменты**. Измените **Редактор внешних скриптов** на **Visual Studio 2017**. Закройте окно **настройки** .

3.  Затем перейдите в раздел   >  **параметры сборки** файлов и переключите платформу на **универсальная платформа Windows**, нажав кнопку **_коммутатора на платформе_** .

4.  Также убедитесь, что:

    1.  **Целевое устройство** настроено для **любого устройства**.

        > Для Microsoft HoloLens задайте для параметра **целевое устройство** значение *HoloLens*.

    2.  Для **типа сборки** задано значение **D3D**.

    3.  **Пакет SDK** установлен в значение " **Последняя установка**".

    4.  **Установлена последняя установленная** **версия Visual Studio** .

    5.  **Сборка и запуск** настроены на **локальный компьютер**.

    6.  Не беспокойтесь о настройке **сцен** прямо сейчас, так как они будут предоставлены позже.

    7.  Остальные параметры должны остаться в данный момент по умолчанию.

        ![Настройка проекта Unity](images/AzureLabs-Lab7-35.png)

5.  В окне **параметры сборки** нажмите кнопку **Параметры проигрывателя** , чтобы открыть связанную панель в пространстве, где находится **инспектор** . 

6. На этой панели необходимо проверить несколько параметров:

    1.  На вкладке **другие параметры** выполните следующие действия.

        1.  Должна быть **экспериментальная** **версия среды выполнения** **сценариев** (эквивалент .NET 4,6)

        2. **Серверная часть сценариев** должна быть **_.NET_**

        3. **Уровень совместимости API** должен быть **.NET 4,6**

            ![Настройка проекта Unity](images/AzureLabs-Lab7-36.png)

    2.  На вкладке **Параметры публикации** в разделе **возможности** установите флажок:

        - **InternetClient**;

            ![Настройка проекта Unity](images/AzureLabs-Lab7-37.png)

    3.  На панели в **параметрах XR** (см. ниже **Параметры публикации**), **поддерживаемая виртуальная реальность** Tick, убедитесь, что добавлен **пакет SDK для Windows Mixed Reality** .

        ![Настройка проекта Unity](images/AzureLabs-Lab7-38.png)

    

6.  Назад в **параметрах сборки** проекты *C# Unity* больше не заключаются; Установите флажок рядом с этим. 

7.  Закройте окно Build Settings (Параметры сборки).

8.  Сохраните проект (**файл > сохранить проект**).

## <a name="chapter-6---importing-the-mlproducts-unity-package"></a>Глава 6. Импорт пакета Unity Млпродуктс

Для этого курса необходимо скачать пакет ресурса Unity под названием [**Azure-MR-307. пакет unitypackage**](https://github.com/Microsoft/HolographicAcademy/raw/Azure-MixedReality-Labs/Azure%20Mixed%20Reality%20Labs/MR%20and%20Azure%20307%20-%20Machine%20learning/307-Scene-Setup.unitypackage). Этот пакет завершается с помощью сцены и всех объектов в этой предварительно построенной, что позволяет сосредоточиться на работе. Предоставляется скрипт **шелфкипер** , хотя содержит только открытые переменные для структуры настройки сцены. Вам потребуется выполнить все остальные разделы. 

Чтобы импортировать этот пакет, выполните следующие действия.

1.  Теперь, когда панель мониторинга Unity находится перед вами, щелкните **ресурсы** в меню в верхней части экрана, а затем щелкните **Импорт пакета, настраиваемый пакет**.

    ![Импорт пакета Unity Млпродуктс](images/AzureLabs-Lab7-39.png)

2.  С помощью средства выбора файлов выберите пакет **Azure-MR-307. пакет unitypackage** и нажмите кнопку **Открыть**.

3.  Отобразится список компонентов для этого актива. Подтвердите импорт, нажав кнопку **Импорт**.

    ![Импорт пакета Unity Млпродуктс](images/AzureLabs-Lab7-40.png)

4.  После завершения импорта вы увидите, что на **панели проекта** Unity появились новые папки. Это трехмерные модели и соответствующие материалы, которые являются частью предварительно подготовленной сцены, с которой вы будете работать. В этом курсе будет написана большая часть кода.

    ![Импорт пакета Unity Млпродуктс](images/AzureLabs-Lab7-41.png)

5.  В папке " **Панель проекта** " щелкните папку " **сцены** " и дважды щелкните сцену внутри (под названием **MR_MachineLearningScene**). Будет открыта сцена (см. изображение ниже). Если красные ромбы отсутствуют, просто нажмите кнопку **приспособлений** в правом верхнем углу **игровой панели**.

    ![Импорт пакета Unity Млпродуктс](images/AzureLabs-Lab7-44.png)

## <a name="chapter-7---checking-the-dlls-in-unity"></a>Глава 7. Проверка библиотек DLL в Unity

Чтобы использовать библиотеки JSON (используемые для сериализации и десериализации), в пакет, который вы выполнили, реализована библиотека DLL Newtonsoft. Библиотека должна иметь правильную конфигурацию, хотя она стоит проверять (особенно при возникновении проблем с кодом не работает). 

Для этого сделайте следующее:

-  Щелкните файл Newtonsoft в папке plugins и посмотрите на **Панель инспектора**. Убедитесь, что **любая платформа** имеет тактовую шкалу. Перейдите на **вкладку UWP** , а также убедитесь, что не **обрабатывать** тика.

    ![Импорт библиотек DLL в Unity](images/AzureLabs-Lab7-48.png)

## <a name="chapter-8---create-the-shelfkeeper-class"></a>Глава 8. Создание класса Шелфкипер

Класс **шелфкипер** размещает методы, управляющие пользовательским интерфейсом и продуктами, порожденными в сцене.

Как часть импортированного пакета, вам будет предоставлен этот класс, хотя он неполон. Теперь пора выполнить этот класс:

1.  Дважды щелкните сценарий **шелфкипер** в папке **Scripts** , чтобы открыть его в **Visual Studio 2017**.

2.  Замените весь код, существующий в скрипте, следующим кодом, который устанавливает время и дату и имеет метод для отображения продукта.

    ```csharp
    using UnityEngine;

    public class ShelfKeeper : MonoBehaviour
    {
        /// <summary>
        /// Provides this class Singleton-like behavior
        /// </summary>
        public static ShelfKeeper instance;

        /// <summary>
        /// Unity Inspector accessible Reference to the Text Mesh object needed for data
        /// </summary>
        public TextMesh dateText;

        /// <summary>
        /// Unity Inspector accessible Reference to the Text Mesh object needed for time
        /// </summary>
        public TextMesh timeText;

        /// <summary>
        /// Provides references to the spawn locations for the products prefabs
        /// </summary>
        public Transform[] spawnPoint;

        private void Awake()
        {
            instance = this;
        }

        /// <summary>
        /// Set the text of the date in the scene
        /// </summary>
        public void SetDate(string day, string month)
        {
            dateText.text = day + " " + month;
        }

        /// <summary>
        /// Set the text of the time in the scene
        /// </summary>
        public void SetTime(string hour)
        {
            timeText.text = hour + ":00";
        }

        /// <summary>
        /// Spawn a product on the shelf by providing the name and selling grade
        /// </summary>
        /// <param name="name"></param>
        /// <param name="sellingGrade">0 being the best seller</param>
        public void SpawnProduct(string name, int sellingGrade)
        {
            Instantiate(Resources.Load(name),
                spawnPoint[sellingGrade].transform.position, spawnPoint[sellingGrade].transform.rotation);
        }
    }
    ```

3.  Не забудьте сохранить изменения в **Visual Studio** перед возвратом в **Unity**.

4.  Вернувшись в редактор Unity, убедитесь, что класс **шелфкипер** выглядит следующим образом:

    ![Создание класса Шелфкипер](images/AzureLabs-Lab7-51.png)

    > [!IMPORTANT]
    > Если в скрипте отсутствуют целевые объекты ссылок (т. е. *Дата (сетка текста)*), просто перетащите соответствующие объекты с **панели Иерархия** в целевые поля. При необходимости см. описание ниже.
    > 
    > 1.  Откройте массив **порожденных точек** в скрипте компонента **шелфкипер** , щелкнув его левой кнопкой мыши. Подраздел будет выглядеть под названием **size**, который указывает размер массива. Введите **3** в текстовое поле рядом с элементом **Размер** и нажмите клавишу **Ввод**, после чего будут созданы три слота.
    > 2. В **иерархии** разверните объект **времени показа** (щелкнув правой кнопкой мыши стрелку рядом с ним). Затем щелкните **_основную камеру_*_ в пределах иерархии _***, чтобы **инспектор** покажет сведения о ней.
    > 3. Выберите **основную камеру** на **панели Иерархия**. Перетащите объекты **даты** и **времени** из **панели Иерархия** в текстовые слоты **даты** и **времени** в **инспекторе** **основной камеры** в компоненте **шелфкипер** .
    > 4. Перетащите **точки порождения** с **панели Иерархия** (под объектом *полка* ) на 3 ссылки на **три** **элемента** , как  показано на рисунке.
    > 
    >     ![Создание класса Шелфкипер](images/AzureLabs-Lab7-52.png)

## <a name="chapter-9---create-the-productprediction-class"></a>Глава 9. Создание класса Продуктпредиктион

Следующий класс, который предстоит создать, — это класс **продуктпредиктион** .

Этот класс отвечает за:

-   Запрос к экземпляру **службы машинное обучение** , в котором указываются текущие дата и время.

-   Десериализация ответа JSON в пригодных для использования данных.

-   Анализ данных с получением трех рекомендуемых продуктов.

-   Вызов методов класса **шелфкипер** для вывода данных в сцене.

Чтобы создать этот класс, сделайте следующее:

1.  Перейдите в папку « **скрипты** » на **панели «проект»**.

2.  Щелкните правой кнопкой мыши внутри папки и выберите **создать**  >  **скрипт C#**. Вызовите скрипт **продуктпредиктион**.

3.  Дважды щелкните новый скрипт **продуктпредиктион** , чтобы открыть его в **Visual Studio 2017**.

4.  Если появится диалоговое окно " **обнаружено изменение файла** ", щелкните **_перезагрузить решение_*.

5.  Добавьте следующие пространства имен в начало класса Продуктпредиктион:

    ```csharp
    using System;
    using System.Collections.Generic;
    using UnityEngine;
    using System.Linq;
    using Newtonsoft.Json;
    using UnityEngine.Networking;
    using System.Runtime.Serialization;
    using System.Collections;
    ```

6.  Внутри класса **продуктпредиктион** вставьте следующие два объекта, состоящие из нескольких вложенных классов. Эти классы используются для сериализации и десериализации JSON для службы Машинное обучение.

    ```csharp
        /// <summary>
        /// This object represents the Prediction request
        /// It host the day of the year and hour of the day
        /// The product must be left blank when serialising
        /// </summary>
        public class RootObject
        {
            public Inputs Inputs { get; set; }
        }

        public class Inputs
        {
            public Input1 input1 { get; set; }
        }

        public class Input1
        {
            public List<string> ColumnNames { get; set; }
            public List<List<string>> Values { get; set; }
        }
    ```

    ```csharp
        /// <summary>
        /// This object containing the deserialised Prediction result
        /// It host the list of the products
        /// and the likelihood of them being sold at current date and time
        /// </summary>
        public class Prediction
        {
            public Results Results { get; set; }
        }

        public class Results
        {
            public Output1 output1;
        }

        public class Output1
        {
            public string type;
            public Value value;
        }

        public class Value
        {
            public List<string> ColumnNames { get; set; }
            public List<List<string>> Values { get; set; }
        }
    ```

7.  Затем добавьте следующие переменные выше предыдущего кода (чтобы код, связанный с JSON, находящийся в нижней части скрипта, ниже всего другого кода, и из него):

    ```csharp
        /// <summary>
        /// The 'Primary Key' from your Machine Learning Portal
        /// </summary>
        private string authKey = "-- Insert your service authentication key here --";

        /// <summary>
        /// The 'Request-Response' Service Endpoint from your Machine Learning Portal
        /// </summary>
        private string serviceEndpoint = "-- Insert your service endpoint here --";

        /// <summary>
        /// The Hour as set in Windows
        /// </summary>
        private string thisHour;

        /// <summary>
        /// The Day, as set in Windows
        /// </summary>
        private string thisDay;

        /// <summary>
        /// The Month, as set in Windows
        /// </summary>
        private string thisMonth;

        /// <summary>
        /// The Numeric Day from current Date Conversion
        /// </summary>
        private string dayOfTheYear;

        /// <summary>
        /// Dictionary for holding the first (or default) provided prediction 
        /// from the Machine Learning Experiment
        /// </summary>    
        private Dictionary<string, string> predictionDictionary;

        /// <summary>
        /// List for holding product prediction with name and scores
        /// </summary>
        private List<KeyValuePair<string, double>> keyValueList;
    ```

    > [!IMPORTANT]
    > Не забудьте вставить конечную точку " **первичный ключ** " и " **запрос-ответ**" с машинное обучение портала в переменные здесь. На приведенных ниже изображениях показано, где можно было взять ключ и конечную точку из. 
    >  
    > ![Машинное обучение Studio (классическая модель): эксперимент](images/AzureLabs-Lab7-53-1.png)
    >
    > ![Машинное обучение Studio (классическая модель): эксперимент](images/AzureLabs-Lab7-53-2.png)

8.  Вставьте этот код в метод **Start ()** . Метод **Start ()** вызывается при инициализации класса:

    ```csharp
        void Start()
        {
            // Call to get the current date and time as set in Windows
            GetTodayDateAndTime();

            // Call to set the HOUR in the UI
            ShelfKeeper.instance.SetTime(thisHour);

            // Call to set the DATE in the UI
            ShelfKeeper.instance.SetDate(thisDay, thisMonth);

            // Run the method to Get Predication from Azure Machine Learning
            StartCoroutine(GetPrediction(thisHour, dayOfTheYear));
        }
    ```

9.  Ниже приведен метод, собирающий дату и время из окон и преобразующий их в формат, который Машинное обучение эксперимент может использовать для сравнения с данными, хранящимися в таблице.

    ```csharp
        /// <summary>
        /// Get current date and hour
        /// </summary>
        private void GetTodayDateAndTime()
        {
            // Get today date and time
            DateTime todayDate = DateTime.Now;

            // Extrapolate the HOUR
            thisHour = todayDate.Hour.ToString();

            // Extrapolate the DATE
            thisDay = todayDate.Day.ToString();
            thisMonth = todayDate.ToString("MMM");

            // Extrapolate the day of the year
            dayOfTheYear = todayDate.DayOfYear.ToString();
        }
    ```

10. Метод **Update ()** можно **Удалить** , так как этот класс не будет его использовать.

11. Добавьте следующий метод, который будет сообщать текущую дату и время к Машинное обучение конечной точке и получить ответ в формате JSON.

    ```csharp
        private IEnumerator GetPrediction(string timeOfDay, string dayOfYear)
        {
            // Populate the request object 
            // Using current day of the year and hour of the day
            RootObject ro = new RootObject
            {
                Inputs = new Inputs
                {
                    input1 = new Input1
                    {
                        ColumnNames = new List<string>
                        {
                            "day",
                            "hour",
                        "product"
                        },
                        Values = new List<List<string>>()
                    }
                }
            };

            List<string> l = new List<string>
            {
                dayOfYear,
                timeOfDay,
                ""
            };

            ro.Inputs.input1.Values.Add(l);

            Debug.LogFormat("Score request built");

            // Serialize the request
            string json = JsonConvert.SerializeObject(ro);

            using (UnityWebRequest www = UnityWebRequest.Post(serviceEndpoint, "POST"))
            {
                byte[] jsonToSend = new System.Text.UTF8Encoding().GetBytes(json);
                www.uploadHandler = new UploadHandlerRaw(jsonToSend);

                www.downloadHandler = new DownloadHandlerBuffer();
                www.SetRequestHeader("Authorization", "Bearer " + authKey);
                www.SetRequestHeader("Content-Type", "application/json");
                www.SetRequestHeader("Accept", "application/json");

                yield return www.SendWebRequest();
                string response = www.downloadHandler.text;

                // Deserialize the response
                DataContractSerializer serializer;
                serializer = new DataContractSerializer(typeof(string));
                DeserialiseJsonResponse(response);
            }
        }
    ```

12. Добавьте следующий метод, который отвечает за десериализацию ответа JSON и передачу результата десериализации в класс **шелфкипер** . В результате будут содержаться названия трех элементов, прогнозируемых для продажи наибольшей актуальности в текущей дате и времени. Вставьте приведенный ниже код в класс **продуктпредиктион** под предыдущим методом.

    ```csharp
        /// <summary>
        /// Deserialize the response received from the Machine Learning portal
        /// </summary>
        public void DeserialiseJsonResponse(string jsonResponse)
        {
            // Deserialize JSON
            Prediction prediction = JsonConvert.DeserializeObject<Prediction>(jsonResponse);
            predictionDictionary = new Dictionary<string, string>();

            for (int i = 0; i < prediction.Results.output1.value.ColumnNames.Count; i++)
            {
                if (prediction.Results.output1.value.Values[0][i] != null)
                {
                    predictionDictionary.Add(prediction.Results.output1.value.ColumnNames[i], prediction.Results.output1.value.Values[0][i]);
                }
            }

            keyValueList = new List<KeyValuePair<string, double>>();

            // Strip all non-results, by adding only items of interest to the scoreList
            for (int i = 0; i < predictionDictionary.Count; i++)
            {
                KeyValuePair<string, string> pair = predictionDictionary.ElementAt(i);
                if (pair.Key.StartsWith("Scored Probabilities"))
                {
                    // Parse string as double then simplify the string key so to only have the item name
                    double scorefloat = 0f;
                    double.TryParse(pair.Value, out scorefloat);
                    string simplifiedName =
                        pair.Key.Replace("\"", "").Replace("Scored Probabilities for Class", "").Trim();
                    keyValueList.Add(new KeyValuePair<string, double>(simplifiedName, scorefloat));
                }
            }

            // Sort Predictions (results will be lowest to highest)
            keyValueList.Sort((x, y) => y.Value.CompareTo(x.Value));

            // Spawn the top three items, from the keyValueList, which we have sorted
            for (int i = 0; i < 3; i++)
            {
                ShelfKeeper.instance.SpawnProduct(keyValueList[i].Key, i);
            }

            // Clear lists in case of reuse
            keyValueList.Clear();
            predictionDictionary.Clear();
        }
    ```

13. Сохраните **Visual Studio** и зашлем обратно в **Unity**.

14. Перетащите скрипт класса **продуктпредиктион** из папки **script** на **основной объект Camera** .

15. Сохраните сцену и файл проекта   >  **сохранить сцену/файл**  >  **сохранить проект**.

## <a name="chapter-10---build-the-uwp-solution"></a>Глава 10. Создание решения UWP

Теперь пора создать проект как решение UWP, чтобы его можно было запускать как автономное приложение.

Для сборки:

1.  Сохраните текущую сцену, щелкнув **файл**  >  **сохранить сцены**.

2.  К   >  **параметрам сборки** файлов

3.  Установите флажок **проекты C# для Unity** (это важно, так как он позволит изменять классы после завершения сборки).

4.  Щелкните **Добавить открытые сцены**,

5.  Щелкните **Построить**.

    ![Создание решения UWP](images/AzureLabs-Lab7-54.png)

6.  Вам будет предложено выбрать папку, в которой нужно построить решение.

7.  Создайте папку **Builds** и в этой папке создайте другую папку с соответствующим именем по своему усмотрению.

8.  Щелкните новую папку, а затем выберите **выбрать папку**, чтобы начать сборку в этом расположении.

    ![Создание решения UWP](images/AzureLabs-Lab7-55.png)

    ![Создание решения UWP](images/AzureLabs-Lab7-56.png)

9.  После того как Unity завершит сборку (может занять некоторое время), он откроет окно **проводника** в расположении сборки (проверьте панель задач, так как она может не всегда отображаться над окнами, но будет уведомлять о добавлении нового окна).

## <a name="chapter-11---deploy-your-application"></a>Глава 11. Развертывание приложения

Чтобы развернуть приложение, выполните следующие действия.

1.  Перейдите к новой сборке Unity (папка **приложения** ) и откройте файл решения в **Visual Studio**.

2.  После открытия Visual Studio необходимо восстановить пакеты NuGet, которые можно выполнить, щелкнув правой кнопкой мыши решение MachineLearningLab_Build, из обозреватель решений (в правой части Visual Studio) и выбрав команду восстановить пакеты NuGet:

    ![Добавление пакетов NuGet](images/AzureLabs-Lab7-57.png)

3.  В конфигурации решения выберите **Отладка**.

4.  На платформе решения выберите **x86**, **локальный компьютер**. 

    > Для Microsoft HoloLens может быть проще установить этот параметр на *Удаленный компьютер*, чтобы вы не были подключены к компьютеру. Однако необходимо также выполнить следующие действия.
    > - Определите **IP-адрес** HoloLens, который можно найти в *параметрах > сети & интернет > Wi-Fi > дополнительные параметры*. IPv4 — это адрес, который следует использовать. 
    > - Убедитесь, **что включен** **режим разработчика** ; находится в *параметрах > Update & > безопасности для разработчиков*.

    ![Добавление пакетов NuGet](images/AzureLabs-Lab7-58.png)

5.  Перейдите в **меню "сборка** " и щелкните " **Развернуть решение** ", чтобы загружать неопубликованные приложение на компьютер.

6.  Теперь приложение должно отобразиться в списке установленных приложений, готовых к запуску.

При запуске приложения Mixed Reality вы увидите, что оно было настроено в сцене Unity, и из инициализации данные, настроенные в Azure, будут получены. Данные будут десериализованы в приложении, а три лучших результата для текущей даты и времени будут предоставлены визуально, как три модели в Bench.


## <a name="your-finished-machine-learning-application"></a>Законченное Машинное обучение приложение
 
Поздравляем, вы создали приложение смешанной реальности, которое использует Машинное обучение Azure, чтобы сделать прогнозы данных и отображать их на сцене.

![Добавление пакетов NuGet](images/AzureLabs-Lab7-0.png)

## <a name="exercise"></a>Упражнение

**Упражнение 1**

Поэкспериментируйте с порядком сортировки приложения и покажите три нижние прогнозы на полке, так как эти данные потенциально также могут быть полезными.

**Упражнение 2**

Использование **таблиц Azure** заполняет новую таблицу сведениями о погоде и создает новый эксперимент с помощью данных.