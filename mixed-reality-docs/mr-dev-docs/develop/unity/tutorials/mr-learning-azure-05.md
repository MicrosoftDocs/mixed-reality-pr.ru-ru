---
title: Учебники по облачным службам Azure, часть 5. Интеграция Службы Azure Bot c помощью LUIS
description: Пройдите этот курс, чтобы узнать, как реализовать Службу Azure Bot и возможность распознавания естественного языка в приложении HoloLens 2.
author: jessemcculloch
ms.author: jemccull
ms.date: 07/01/2020
ms.topic: article
keywords: смешанная реальность, Unity, учебник, HoloLens, HoloLens 2, служба Azure Bot, LUIS, естественный язык, чат-бот, облачные службы Azure, Пользовательское визуальное распознавание Azure, Windows 10
ms.localizationpriority: high
ms.openlocfilehash: d9884fc135a38e610df9faceb8cf4b24c21f7982
ms.sourcegitcommit: dd13a32a5bb90bd53eeeea8214cd5384d7b9ef76
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/17/2020
ms.locfileid: "94679363"
---
# <a name="5-integrating-azure-bot-service"></a>5. Интеграция Службы Azure Bot

Из этого учебника вы узнаете, как использовать **Службу Azure Bot** в демонстрационном приложении **HoloLens 2**, чтобы добавить возможность распознавания речи (LUIS) и разрешить боту помогать пользователю во время поиска **отслеживаемых объектов**. Этот учебник состоит из двух частей. В первой части вы создадите бота с помощью приложения [Bot Composer](https://docs.microsoft.com/composer/introduction) в качестве решения без кода и выполните краткий обзор Функции Azure, которая предоставляет боту необходимые данные. Во второй части вы будете использовать компонент **BotManager (script)** (Диспетчер ботов — скрипт) в проекте Unity для использования размещенной Службы Bot.

## <a name="objectives"></a>Задачи

## <a name="part-1"></a>Часть 1

* Получите основные сведения о Службе Azure Bot.
* Узнайте, как создать бота с помощью приложения Bot Composer.
* Узнайте, как использовать функцию Azure для предоставления данных из службы хранилища Azure.

## <a name="part-2"></a>Часть 2

* Узнайте, как настроить сцену для использования Службы Azure Bot в этом проекте.
* Узнайте, как настроить и найти объекты с помощью бота.

## <a name="understanding-azure-bot-service"></a>Общие сведения о Службе Azure Bot

**Служба Azure Bot** позволяет разработчикам создавать интеллектуальных ботов, которые могут поддерживать естественное общение с пользователями благодаря **LUIS**. Чат-бот — это отличный способ расширить возможности взаимодействия пользователя с приложением. Бот можно использовать в качестве базы знаний с помощью [QnA Maker](https://docs.microsoft.com/azure/bot-service/bot-builder-howto-qna?view=azure-bot-service-4.0&tabs=cs&preserve-view=true) для поддержания сложного разговора с использованием службы [распознавания речи (LUIS)](https://docs.microsoft.com/azure/bot-service/bot-builder-howto-v4-luis?view=azure-bot-service-4.0&tabs=csharp&preserve-view=true).

Дополнительные сведения о [Службе Azure Bot](https://docs.microsoft.com/azure/bot-service/bot-service-overview-introduction?view=azure-bot-service-4.0&preserve-view=true)

## <a name="part-1---creating-the-bot"></a>Часть 1. Создание бота

Прежде чем использовать бота в приложении Unity, его необходимо разработать, предоставить ему данные и разместить в **Azure**.
Цель бота — оценить количество *отслеживаемых объектов*, хранимых в базе данных, найти *отслеживаемый объект* по его имени и сообщить пользователю базовую информацию о нем.

### <a name="a-quick-look-into-tracked-objects-azure-function"></a>Краткий обзор функции отслеживаемых объектов в Azure

Вы собираетесь приступить к созданию бота, но чтобы сделать его полезным, необходимо предоставить ресурс, из которого он может извлекать данные. Так как *бот* сможет подсчитать количество **отслеживаемых объектов**, найти конкретные объекты по имени и сообщить подробности, вы будете использовать простую Функцию Azure с доступом к **хранилищу таблиц Azure**.

Скачайте проект функции Azure отслеживаемых объектов: [AzureFunction_TrackedObjectsService.zip](https://github.com/microsoft/MixedRealityLearning/releases/download/azure-cloud-services-v2.4.0/AzureFunction_TrackedObjectsService.zip). Затем извлеките его на свой жесткий диск.

Эта функция Azure может выполнять действия **подсчета** и **поиска**, которые можно вызвать с помощью базовых вызовов *HTTP* *GET*. Код можно проверить в **Visual Studio**.

Дополнительные сведения о [функциях Azure](https://docs.microsoft.com/azure/azure-functions/functions-overview).

Функция **Count** запрашивает из **хранилища таблиц** все **отслеживаемые объекты**. С другой стороны, функция **Find** принимает параметр запроса *имени* из запроса *GET* и запрашивает **хранилище таблиц** для сопоставления **отслеживаемых объектов** и возвращает DTO в виде JSON.

Вы можете развернуть эту **Функцию Azure** непосредственно из **Visual Studio**.
Здесь вы найдете все сведения о [развертывании Функции Azure](https://docs.microsoft.com/azure/devops/pipelines/targets/azure-functions?view=azure-devops&tabs=dotnet-core%2Cyaml&preserve-view=true).

После завершения развертывания на **портале Azure** откройте соответствующий ресурс и выберите вкладку **Конфигурация** в разделе *Параметры*. На вкладке **Параметры приложения** необходимо предоставить *строку подключения* для **хранилища Azure**, где хранятся **отслеживаемые объекты**. Щелкните элемент **Новый параметр приложения** и в качестве имени введите: **AzureStorageConnectionString**, а в качестве значения предоставьте правильную *строку подключения*. После этого нажмите на кнопку **Сохранить**, и **Функция Azure** будет готова к размещению *бота* на сервере, который вы создадите далее.

### <a name="creating-a-conversation-bot"></a>Создание чат-бота

Существует несколько способов разработки чат-бота на основе платформы Bot Framework. На этом уроке вы будете использовать классическое приложение [Bot Framework Composer](https://docs.microsoft.com/composer/), которое является визуальным конструктором и идеально подходит для быстрой разработки.

Последние выпуски можно скачать из [репозитория GitHub](https://github.com/microsoft/BotFramework-Composer/releases). Он доступен для Windows, Mac и Linux.

После установки **Bot Framework Composer** запустите приложение, и вы увидите этот интерфейс:

![Bot Framework Composer — домашняя страница](images/mr-learning-azure/tutorial5-section4-step1-1.png)

Мы подготовили проект Bot Composer, который предоставляет необходимые диалоги и триггеры для работы с этим руководством. Скачайте проект Bot Framework Composer: [BotComposerProject_TrackedObjectsBot.zip](https://github.com/microsoft/MixedRealityLearning/releases/download/azure-cloud-services-v2.4.0/BotComposerProject_TrackedObjectsBot.zip). Затем извлеките его на свой жесткий диск.

На верхней панели нажмите кнопку **Open** (Открыть) и выберите скачанный проект Bot Framework с именем **TrackedObjectsBot**. После полной загрузки проекта вы увидите, что проект готов.

![Bot Framework Composer с открытым проектом TrackedObjectsBot](images/mr-learning-azure/tutorial5-section4-step1-2.png)

Обратите внимание на **панель диалогов** в левой части страницы. Здесь расположено диалоговое окно **TrackedObjectsBot**, в котором можно увидеть несколько **триггеров**.

Дополнительные сведения об [основных понятиях Bot Framework](https://docs.microsoft.com/composer/concept-dialog).

Эти триггеры выполняют следующие действия:

#### <a name="greeting"></a>Приветствие

Это точка входа *чат-бота*, когда какой-либо *пользователь* инициирует диалог.

![Диалоговое окно проекта TrackedObjectsBot с возможностью выбора триггера — приветствие](images/mr-learning-azure/tutorial5-section4-step1-3.png)

#### <a name="askingforcount"></a>AskingForCount

Это диалоговое окно активируется, когда *пользователь* запрашивает подсчет всех **отслеживаемых объектов**.
Ниже приведены триггерные фразы:

>* count me all (подсчитать все);
>* how many are stored (количество хранимых).

![Диалоговое окно проекта TrackedObjectsBot — AskForCount](images/mr-learning-azure/tutorial5-section4-step1-4.png)

Благодаря [LUIS](https://docs.microsoft.com/composer/how-to-use-luis) *пользователю* не нужно запрашивать фразы естественным для *пользователя* способом.

В этом диалоговом окне *бот* также будет обращаться к Функции Azure **Count**. Дополнительные сведения об этом см. ниже.

#### <a name="unknown-intent"></a>Неизвестная цель

Это диалоговое окно запускается, если входные данные *пользователя* не соответствуют никаким другим условиям триггера, и просит пользователя повторно задать свой вопрос.

![Диалоговое окно проекта TrackedObjectsBot с возможностью выбора триггера — неизвестное намерение](images/mr-learning-azure/tutorial5-section4-step1-5.png)

#### <a name="findentity"></a>FindEntity

Последнее диалоговое окно более сложное. Здесь приведены функции ветвления и хранения данных в памяти *ботов*.
Оно запрашивает у пользователя *имя* **отслеживаемого объекта**, о котором необходимо узнать больше информации, выполняет запрос Функции Azure **Find** и использует ответ для продолжения разговора.

![Диалоговое окно проекта TrackedObjectsBot с возможностью выбора триггера — FindEntity](images/mr-learning-azure/tutorial5-section4-step1-6.png)

Если **отслеживаемый объект** не найден, пользователь получает уведомление, а разговор завершается. Когда рассматриваемый **отслеживаемый объект** будет найден, загрузчик проверит, какие свойства доступны, и сообщит о них.

### <a name="adapting-the-bot"></a>Адаптация бота

Триггерам **AskingForCount** и **FindEntity** необходимо взаимодействовать с серверной частью. Это означает, что необходимо добавить правильный URL-адрес **Функции Azure**, развернутой ранее.

На панели диалоговых окон щелкните **AskingForCount** и выберите действие *Send an HTTP request* (Отправить HTTP-запрос). Здесь можно увидеть поле **URL**, в которое необходимо ввести правильный URL-адрес конечной точки функции **Count**.

![Диалоговое окно AskingForCount проекта TrackedObjectsBot с возможностью выбора триггера — конфигурация конечной точки](images/mr-learning-azure/tutorial5-section5-step1-1.png)

Наконец, найдите триггер **FindEntity** и действие *Send an HTTP request* (Отправить HTTP-запрос). В поле **URL** замените URL-адрес конечной точкой функции **Count**.

![Диалоговое окно FindEntity проекта TrackedObjectsBot с возможностью выбора триггера — конфигурация конечной точки](images/mr-learning-azure/tutorial5-section5-step1-2.png)

Теперь все готово к развертыванию бота. Так как у вас установлена программа Bot Framework Composer, его можно опубликовать непосредственно из нее.

Дополнительные сведения о [публикации бота с помощью программы Bot Composer](https://docs.microsoft.com/composer/how-to-publish-bot).

> [!TIP]
> Вы можете поэкспериментировать с ботом, добавив дополнительные триггерные фразы, новые ответы или ветвление диалога.

## <a name="part-2---putting-everything-together-in-unity"></a>Часть 2. Размещение всех элементов в Unity

### <a name="preparing-the-scene"></a>Подготовка сцены

В окне проекта перейдите к папке **Assets** > **MRTK.Tutorials.AzureCloudServices** > **Prefabs** > **Manager**.

![Окно проекта Unity с выбранной заготовкой ChatBotManager](images/mr-learning-azure/tutorial5-section6-step1-1.png)

После этого переместите заготовку **ChatBotManager** в иерархию сцены.

Добавив ChatBotManager в сцену, щелкните компонент **Chat Bot Manager** (Диспетчер чат-ботов).
В окне Inspector (Инспектор) вы увидите, что имеется пустое поле **Direct Line Secret Key** (Секретный ключ прямой линии), которое необходимо заполнить.

> [!TIP]
> Вы можете получить *секретный ключ* на портале Azure, выполнив поиск ресурса типа **регистрации каналов ботов**, созданного в первой части этого учебника.

![Unity с добавленной заготовкой ChatBotManager](images/mr-learning-azure/tutorial5-section6-step1-2.png)

Теперь вы подключите объект **ChatBotManager** с компонентом **ChatBotController**, присоединенным к объекту **ChatBotPanel**. В окне Hierarchy (Иерархия) выберите **ChatBotPanel**, и вы увидите пустое поле **Chat Bot Manager** (Диспетчер чат-ботов). Перетащите объект **ChatBotManager** в пустое поле **Chat Bot Manager** (Диспетчер чат-ботов).

![Unity с настроенным объектом ChatBotPanel](images/mr-learning-azure/tutorial5-section6-step1-3.png)

Далее необходимо открыть объект **ChatBotPanel**, чтобы пользователь мог взаимодействовать с ним. В окне Scene (Сцена) вы могли заметить, что в объекте **MainMenu** есть кнопка *Chat Bot* (Чат-бот), которая будет использоваться для решения этой проблемы.

В окне Hierarchy (Иерархия) откройте папку **RootMenu** > **MainMenu** > **SideButtonCollection** > **ButtonChatBot** и найдите в окне Inspector (Инспектор) скрипт *ButtonConfigHelper*. Там вы увидите пустой слот в функции обратного вызова события **OnClick ()** . Перетащите **ChatBotPanel** в область событий, из раскрывающегося списка выберите *GameObject*, а затем в подменю выберите *SetActive (bool)* (SetActive (логическое)) и установите флажок.

![Unity с настроенным объектом ButtonChatBot](images/mr-learning-azure/tutorial5-section6-step1-4.png)

Теперь чат-бот можно запустить из главного меню, а сцена готова к использованию.

### <a name="putting-the-bot-to-a-test"></a>Тестирование чат-бота

#### <a name="asking-about-the-quantity-of-tracked-objects"></a>Запрос количества отслеживаемых объектов

Сначала вы проверите, сколько **отслеживаемых объектов** хранится в базе данных.

> [!NOTE]
> На этот раз необходимо запустить приложение из HoloLens 2, так как такие службы, как *преобразование текста в речь*, могут быть недоступны в вашей системе.

Запустите приложение в HoloLens 2 и нажмите кнопку *Chat Bot* (Чат-бот) рядом с главным меню.
Чат-бот поприветствует вас. Спросите, **сколько имеется объектов?**
Он должен сообщить их количество и завершить диалог.

#### <a name="asking-about-a-tracked-object"></a>Запрос отслеживаемого объекта

Теперь запустите приложение еще раз и попросите **найти отслеживаемый объект**. Чат-бот запросит название, на которое следует ответить, например введите "автомобиль", или имя другого *отслеживаемого объекта*, который есть в базе данных. Бот отобразит его описание и сведения о наличии пространственной привязки.

> [!TIP]
> Попробуйте запросить **отслеживаемые объекты**, которые не существуют в базе, и посмотрите на ответ бота.

## <a name="congratulations"></a>Поздравляем!

Из этого учебника вы узнали, как можно использовать платформу Azure Bot Framework для взаимодействия с приложением с помощью естественного языка. Вы узнали, как разрабатывать собственных ботов и как они работают.

## <a name="conclusion"></a>Заключение

В рамках этой серии учебников вы узнали, как **облачные службы Azure** применяют новые интересные функции к вашему приложению.
Теперь вы можете хранить данные и изображения в облаке **хранилища Azure**, использовать **Пользовательское визуальное распознавание Azure** для связывания изображений и обучения модели, передавать объекты в локальный контекст с помощью **Пространственных привязок Azure** и реализовать **Azure Bot Framework на платформе LUIS**, чтобы добавить чат-бота в новый и естественный шаблон взаимодействия.
