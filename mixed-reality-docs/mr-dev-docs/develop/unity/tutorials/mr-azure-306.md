---
title: 306. Смешанная реальность и Azure — потоковая передача видео
description: Пройдите этот курс, чтобы узнать, как реализовать службы мультимедиа Azure в приложении смешанной реальности.
author: drneil
ms.author: jemccull
ms.date: 07/04/2018
ms.topic: article
keywords: Azure, Mixed Reality, Academy, Unity, учебник, API, службы мультимедиа, потоковая передача видео, 360, иммерсивное, VR, Windows 10, Visual Studio
ms.openlocfilehash: 3a0401b7503d8a783ba529cf24cdf6cc55c88311
ms.sourcegitcommit: d3a3b4f13b3728cfdd4d43035c806c0791d3f2fe
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/20/2021
ms.locfileid: "98583454"
---
# <a name="mr-and-azure-306-streaming-video"></a>306. Смешанная реальность и Azure: потоковое видео

<br>

>[!NOTE]
>Руководства Mixed Reality Academy были разработаны для иммерсивных гарнитур HoloLens (1-го поколения) и иммерсивных гарнитур Mixed Reality.  Поэтому мы считаем, что важно оставить эти руководства для разработчиков, которые ищут рекомендации по разработке для этих устройств.  Данные руководства **_не_** будут обновляться с учетом последних наборов инструментов или возможностей взаимодействия для HoloLens 2.  Они будут сохранены для работы на поддерживаемых устройствах. Появится новая серия руководств, которые будут опубликованы в будущем, где будет показано, как разрабатывать данные для HoloLens 2.  Это уведомление будет обновлено ссылкой на эти учебники при их публикации.

<br> 

![окончательный продукт. запуск ](images/AzureLabs-Lab6-00.png)
 ![ окончательного продукта — запуск](images/AzureLabs-Lab6-01.png)

В этом курсе вы узнаете, как подключить службы мультимедиа Azure к операционной системе Windows Mixed Reality, чтобы разрешить воспроизведение видео в режиме потоковой передачи 360 на впечатляющих наушниках. 

**Службы мультимедиа Azure** — это набор служб, которые предоставляют высококачественные службы потоковой передачи видео для достижения больших аудиторий на современных наиболее популярных мобильных устройствах. Дополнительные сведения см. на [странице служб мультимедиа Azure](https://azure.microsoft.com/services/media-services).

Прополнив этот курс, вы получите иммерсивное приложение для наушников, которое сможет сделать следующее:

1. Получите видео 360 градусов из службы **хранилища Azure** через **службу мультимедиа Azure**.

2. Отобразить полученное видео 360 градусов в сцене Unity.

3. Переход между двумя сценами с двумя различными видео.

В приложении вы будете выполнять интеграцию результатов с вашей структурой. Этот курс предназначен для изучения того, как интегрировать службу Azure с проектом Unity. Это ваша задача использовать знания, полученные из этого курса, для улучшения приложения смешанной реальности.

## <a name="device-support"></a>Поддержка устройств

<table>
<tr>
<th>Курс</th><th style="width:150px"> <a href="/hololens/hololens1-hardware">HoloLens</a></th><th style="width:150px"> <a href="../../../discover/immersive-headset-hardware-details.md">Иммерсивные гарнитуры</a></th>
</tr><tr>
<td> 306. Смешанная реальность и Azure: потоковое видео</td><td style="text-align: center;"> </td><td style="text-align: center;"> ✔️</td>
</tr>
</table>

## <a name="prerequisites"></a>Предварительные требования

> [!NOTE]
> Этот учебник предназначен для разработчиков, имеющих базовый опыт работы с Unity и C#. Также имейте в виду, что предварительные требования и письменные инструкции в этом документе отражают, что проверялось и проверено во время написания статьи (Май 2018). Вы можете использовать новейшее программное обеспечение, как указано в [статье Установка средств](../../install-the-tools.md), но не следует предполагать, что информация в этом курсе будет полностью соответствовать тому, что вы найдете в более новом программном обеспечении, чем показано ниже.

Для этого курса рекомендуется следующее оборудование и программное обеспечение:

- ПК для разработки, [совместимый с Windows Mixed Reality](https://support.microsoft.com/help/4039260/windows-10-mixed-reality-pc-hardware-guidelines) для разработки головных телефонов (VR)
- [Windows 10 для дизайнеров с обновлением (или более поздней версии) с включенным режимом разработчика](../../install-the-tools.md#installation-checklist)
- [Последний пакет SDK для Windows 10](../../install-the-tools.md#installation-checklist)
- [Unity 2017,4](../../install-the-tools.md#installation-checklist)
- [Visual Studio 2017](../../install-the-tools.md#installation-checklist)
- [Головной телефон Windows Mixed Reality (VR)](../../../discover/immersive-headset-hardware-details.md)
- Доступ к Интернету для установки Azure и извлечения данных
- Видео 2 360-градусы в формате MP4 ( [на этой странице скачивания](https://www.mettle.com/360vr-master-series-free-360-downloads-page)можно найти бесплатные видеоматериалы)

## <a name="before-you-start"></a>Перед началом работы

1.  Чтобы избежать проблем при создании этого проекта, настоятельно рекомендуется создать проект, упомянутый в этом руководстве, в корневой или ближайшем к корневой папке (длинные пути к папкам могут вызвать проблемы во время сборки).
2.  Настройка и тестирование иммерсивного наушников смешанной реальности.

    > [!NOTE]
    > Для этого курса **не** потребуется использовать контроллеры движения. Если вам нужна поддержка настройки иммерсивного головного телефона, щелкните ссылку, [чтобы настроить Windows Mixed Reality](https://support.microsoft.com/help/4043101/windows-10-set-up-windows-mixed-reality).

## <a name="chapter-1---the-azure-portal-creating-the-azure-storage-account"></a>Глава 1. Создание учетной записи хранения Azure с помощью портала Azure

Чтобы использовать **службу хранилища Azure**, вам потребуется создать и настроить **учетную запись хранения** в портал Azure.

1.  Войдите на [портал Azure](https://portal.azure.com).

    > [!NOTE]
    > Если у вас еще нет учетной записи Azure, необходимо создать ее. Если вы используете этот учебник в учебной или лабораторной ситуации, обратитесь к своему преподавателю или к одной из прокторс, чтобы получить помощь в настройке новой учетной записи.

2.  После входа в меню слева щелкните **учетные записи хранения** .

    ![Настройка учетной записи хранения Azure](images/AzureLabs-Lab6-02.png)

3.  На вкладке **учетные записи хранения** щелкните **Добавить**.

    ![Настройка учетной записи хранения Azure](images/AzureLabs-Lab6-03.png)

4.  На вкладке **Создание учетной записи хранения** выполните следующие действия.

    1.  Введите **имя** для своей учетной записи. Имейте в виду, что это поле принимает только цифры и строчные буквы.

    2.  В качестве **модели развертывания** выберите **Resource Manager**.

    3.  В качестве **типа учетной записи** выберите **хранилище (общее назначение v1)**.

    4.  Для **повышения производительности** выберите **стандартный *.**

    5.  Для **репликации** выберите **локально избыточное хранилище (LRS)**.

    6.  Оставьте **защищенное перемещение обязательным** , как **отключено**.

    7.  Выберите **подписку**.

    8.  Выберите **группу ресурсов** или создайте новую. Группа ресурсов предоставляет способ мониторинга, контроля доступа, подготовки счетов и управления ими для коллекции ресурсов Azure.

    9.  Определите **Расположение** группы ресурсов (при создании новой группы ресурсов). В идеале это расположение будет находиться в регионе, в котором будет выполняться приложение. Некоторые ресурсы Azure доступны только в определенных регионах.

5.  Необходимо подтвердить, что вы поняли условия, примененные к этой службе.

    ![Настройка учетной записи хранения Azure](images/AzureLabs-Lab6-04.png)

6.  После нажатия кнопки **создать** необходимо подождать, пока не будет создана служба, а это может занять некоторое время.

7.  После создания экземпляра службы на портале отобразится уведомление.

    ![Настройка учетной записи хранения Azure](images/AzureLabs-Lab6-05.png)

8.  На этом этапе вам не нужно следовать за ресурсом, просто перейдите к следующей главе.

## <a name="chapter-2---the-azure-portal-creating-the-media-service"></a>Глава 2. Создание службы мультимедиа на портале Azure

Чтобы использовать службу мультимедиа Azure, необходимо настроить экземпляр службы, чтобы сделать ее доступной для приложения (где владелец учетной записи должен быть администратором).

1.  На портале Azure щелкните **создать ресурс** в левом верхнем углу экрана и найдите **службу мультимедиа,** нажав клавишу **Ввод**. В настоящий момент ресурс имеет розовый значок; Щелкните здесь, чтобы отобразить новую страницу.

    ![портал Azure;](images/AzureLabs-Lab6-06.png)

2.  На новой странице будет представлено описание **службы мультимедиа**. В нижнем левом углу этого запроса нажмите кнопку " **создать** ", чтобы создать связь с этой службой.

    ![портал Azure;](images/AzureLabs-Lab6-07.png)

3.  После нажатия кнопки **создать** панель появится место, где необходимо указать сведения о новой службе мультимедиа.

    1.  Вставьте имя нужной **учетной записи** для этого экземпляра службы.

    2.  Выберите **подписку**.

    3. Выберите **группу ресурсов** или создайте новую. Группа ресурсов предоставляет способ мониторинга, контроля доступа, подготовки счетов и управления ими для коллекции ресурсов Azure. Рекомендуется, чтобы все службы Azure, связанные с одним проектом (например, в этих лабораториях), были в общей группе ресурсов. 
    
    > Если вы хотите ознакомиться с дополнительными сведениями о группах ресурсов Azure, перейдите [по этой ссылке, чтобы управлять группами ресурсов Azure](/azure/azure-resource-manager/resource-group-portal).

    4.  Определите **Расположение** группы ресурсов (при создании новой группы ресурсов). В идеале это расположение будет находиться в регионе, в котором будет выполняться приложение. Некоторые ресурсы Azure доступны только в определенных регионах.

    5.  В разделе **учетная запись хранения** щелкните раздел **выберите...** , а затем щелкните **учетную запись хранения** , созданную в последней главе.

    6.  Также необходимо подтвердить, что вы поняли условия, примененные к этой службе.

    7.  Нажмите кнопку **Создать**.

        ![портал Azure;](images/AzureLabs-Lab6-08.png)

4.  После нажатия кнопки **создать** необходимо подождать, пока не будет создана служба, а это может занять некоторое время.

5.  После создания экземпляра службы на портале отобразится уведомление.

    ![портал Azure;](images/AzureLabs-Lab6-09.png)

6.  Щелкните уведомление, чтобы просмотреть новый экземпляр службы.

    ![портал Azure;](images/AzureLabs-Lab6-10.png)

7.  Нажмите кнопку " **Переход к ресурсу** " в уведомлении, чтобы изучить новый экземпляр службы.

8.  На странице Новая служба мультимедиа на панели слева щелкните ссылку **ресурсы** , что находится примерно в середине.

9.  На следующей странице в левом верхнем углу страницы щелкните **Отправить**.

    ![портал Azure;](images/AzureLabs-Lab6-11.png)

10. Щелкните значок **папки** , чтобы просмотреть файлы и выбрать первое 360 видео, которое требуется передать в поток. 
    
    > Можно перейти по этой [ссылке, чтобы скачать пример видео](https://vimeo.com/214401712).

    ![портал Azure;](images/AzureLabs-Lab6-12.png)

> [!WARNING]
> Длинные имена файлов могут вызвать проблемы с кодировщиком: так, чтобы в видеороликах не было проблем, рекомендуется сократить длину имен видеофайлов.

11. Индикатор выполнения будет зеленым после отправки видео.

    ![портал Azure;](images/AzureLabs-Lab6-13.png)

12. Щелкните приведенный выше текст (**йоурсервиценаме-Assets**), чтобы вернуться на страницу " **активы** ".

13. Вы увидите, что видео успешно отправлено. Щелкните ее.

    ![портал Azure;](images/AzureLabs-Lab6-14.png)

14. На странице, на которую вы перенаправляетесь, отобразятся подробные сведения о видео. Чтобы иметь возможность использовать видео, необходимо его кодировать, нажав кнопку " **Кодировка** " в верхней левой части страницы.

    ![портал Azure;](images/AzureLabs-Lab6-15.png)

15. Справа появится новая панель, где можно будет задать параметры кодировки для файла. Задайте следующие свойства (некоторые будут уже заданы по умолчанию):

    1.  **Имя кодировщика мультимедиа *Media Encoder Standard***

    2.  **Кодирование предустановленного *содержимого Адаптивная* многоскоростная скорость MP4**

    3.  **Имя задания *, Media Encoder Standard обработка Video1.mp4***

    4.  **Имя выходного ресурса мультимедиа *Video1.mp4--Media Encoder Standard в кодировке***

        ![портал Azure;](images/AzureLabs-Lab6-16.png)

16. Нажмите кнопку **Создать** .

17. Вы увидите строку с **добавленным заданием кодирования**, щелкните эту панель, и появится панель со сведениями о ходе кодирования.

    ![портал Azure;](images/AzureLabs-Lab6-17.png)

    ![портал Azure;](images/AzureLabs-Lab6-18.png)

18. Дождитесь завершения задания. После этого вы можете закрыть панель с крестиком в правом верхнем углу этой панели.

    ![портал Azure;](images/AzureLabs-Lab6-19.png)

    ![портал Azure;](images/AzureLabs-Lab6-20.png)

    > [!IMPORTANT]
    > Время, необходимое для этого, зависит от размера файла видео. Этот процесс может занять довольно много времени.

19. Теперь, когда закодированная версия видео создана, ее можно опубликовать, чтобы сделать доступной. Для этого щелкните ссылку "синие **ресурсы** ", чтобы вернуться на страницу "активы".

    ![портал Azure;](images/AzureLabs-Lab6-21.png)

20. Вы увидите видео вместе с другим, который относится к **типу ресурса с _несколькими скоростями MP4_**.

    ![портал Azure;](images/AzureLabs-Lab6-22.png)

    > [!NOTE] 
    > Вы можете заметить, что новый ресурс, рядом с исходным видео, *неизвестен* и имеет значение 0 байт для его **размера**. просто обновите окно, чтобы обновить его.

21. Щелкните этот новый ресурс.

    ![портал Azure;](images/AzureLabs-Lab6-23.png)

22. Вы увидите аналогичную панель, которая использовалась ранее, а только это другой ресурс. Нажмите кнопку **опубликовать** , расположенную в верхней части страницы.

    ![портал Azure;](images/AzureLabs-Lab6-24.png)

23. Вам будет предложено задать **указатель**, который является точкой входа, к файлу/s в ваших ресурсах. Для сценария задайте следующие свойства:

    1.  **Тип указателя**  >  **Прогрессивный**.

    2.  **Дата** и **время** будут установлены для вас, от текущей даты до времени в будущем (в данном случае 100 лет). Оставьте "как есть" или измените его на "масть".

    > [!NOTE]
    > Дополнительные сведения об указателях и о том, что можно выбрать, см. в [документации по службам мультимедиа Azure](/azure/media-services/media-services-concepts).

24. В нижней части этой панели нажмите кнопку **Добавить** .

    ![портал Azure;](images/AzureLabs-Lab6-25.png)

25. Теперь ваше видео Опубликовано, и его можно перепотокировать с помощью конечной точки. Ниже приведен раздел « **файлы** ». Именно здесь будут использоваться разные закодированные версии вашего видео. Выберите наибольшее возможное разрешение (на изображении ниже, это файл 1920x960), после чего появится панель справа. Здесь вы найдете **URL-адрес для скачивания**. Скопируйте эту **конечную точку** , так как она будет использоваться позже в коде.

    ![портал Azure;](images/AzureLabs-Lab6-26.png)    

    ![портал Azure;](images/AzureLabs-Lab6-27.png)

    > [!NOTE] 
    > Можно также нажать кнопку **Воспроизведение** , чтобы воспроизвести видео и протестировать его.

26. Теперь необходимо отправить второе видео, которое будет использоваться в этой лаборатории. Выполните описанные выше действия, повторив тот же процесс для второго видео. Убедитесь, что вы также скопировали вторую **конечную точку** . [Чтобы скачать второе видео](https://vimeo.com/214402865), используйте следующую ссылку.

27. После публикации обоих видео вы можете перейти к следующей главе.

## <a name="chapter-3---setting-up-the-unity-project"></a>Глава 3. Настройка проекта Unity

Ниже приведена типичная Настройка для разработки с использованием смешанной реальности, которая является хорошим шаблоном для других проектов.

1.  Откройте **Unity** и нажмите кнопку **создать**. 

    ![портал Azure;](images/AzureLabs-Lab6-28.png)

2.  Теперь необходимо указать имя проекта Unity, вставить **MR \_ 360VideoStreaming.**. Убедитесь, что для типа проекта задано значение **3D**. Задайте для расположения нужное расположение (Помните, что ближе к корневым каталогам лучше). Затем нажмите кнопку **создать проект**.

    ![портал Azure;](images/AzureLabs-Lab6-29.png)

3.  При открытом Unity стоит проверить, что для **редактора скриптов** по умолчанию задано значение **Visual Studio.** Перейдите к разделу **_изменение_ *настроек*** , а затем в новом окне перейдите к разделу **Внешние инструменты**. Измените **Редактор внешних скриптов** на **Visual Studio 2017**. Закройте окно **настройки** .

    ![портал Azure;](images/AzureLabs-Lab6-30.png)

4.  Затем перейдите в раздел ***параметры сборки* файлов** и переключите платформу на **универсальная платформа Windows**, нажав кнопку **коммутатора на платформе** .

5.  Также убедитесь, что:

    1. **Целевое устройство** настроено для **любого устройства.**
    
    2.  Для **типа сборки** задано значение **D3D.**

    3.  **Пакет SDK** установлен в значение " **Последняя установка".**

    4.  **Установлена последняя установленная** **версия Visual Studio** .

    5.  **Сборка и запуск** настроены на **локальный компьютер.**

    6.  Не беспокойтесь о настройке **сцен** прямо сейчас, так как они будут настроены позже.

    7.  Остальные параметры должны остаться в данный момент по умолчанию.

        ![Настройка проекта Unity](images/AzureLabs-Lab6-31.png)

6.  В окне **параметры сборки** нажмите кнопку **Параметры проигрывателя** , чтобы открыть связанную панель в пространстве, где находится **инспектор** . 

7. На этой панели необходимо проверить несколько параметров:

    1.  На вкладке **другие параметры** выполните следующие действия.

        1.   **Версия среды выполнения** сценариев должна быть **стабильной** (эквивалент .NET 3,5).

        2. **Серверная часть сценариев** должна быть **.NET.**

        3. **Уровень совместимости API** должен быть **.NET 4,6.**

            ![Настройка проекта Unity](images/AzureLabs-Lab6-32.png)

    2.  На более низких панели в **параметрах XR** (см. ниже **Параметры публикации**), **поддерживаемая виртуальная реальность** Tick, убедитесь, что добавлен **пакет SDK для Windows Mixed Reality** .

        ![Настройка проекта Unity](images/AzureLabs-Lab6-33.png)

    3.  На вкладке **Параметры публикации** в разделе **возможности** установите флажок:

        - **InternetClient**;

            ![Настройка проекта Unity](images/AzureLabs-Lab6-34.png)

8.  После внесения этих изменений закройте окно **параметры сборки** .

9.  Сохраните проект **файл* * сохранить проект * *.



## <a name="chapter-4---importing-the-insideoutsphere-unity-package"></a>Глава 4. Импорт пакета Unity Инсидеаутсфере

> [!IMPORTANT]
> Если вы хотите пропустить компонент *установки Unity, установленный* в этом курсе, и продолжить работу с кодом, скачайте этот файл [. пакет unitypackage](https://github.com/Microsoft/HolographicAcademy/raw/Azure-MixedReality-Labs/Azure%20Mixed%20Reality%20Labs/MR%20and%20Azure%20306%20-%20Streaming%20video/Azure-MR-306.unitypackage), импортируйте его в проект как [**пользовательский пакет**](https://docs.unity3d.com/Manual/AssetPackages.html), а затем продолжайте в **главе 5**. Вам все равно придется создать проект Unity.

Для этого курса необходимо скачать пакет ресурса Unity с именем [**инсидеаутсфере. пакет unitypackage**](https://github.com/Microsoft/HolographicAcademy/raw/Azure-MixedReality-Labs/Azure%20Mixed%20Reality%20Labs/MR%20and%20Azure%20306%20-%20Streaming%20video/InsideOutSphere.unitypackage).

Как импортировать **пакет unitypackage**:

1.  Теперь, когда панель мониторинга Unity находится перед вами, щелкните **ресурсы** в меню в верхней части экрана, а затем щелкните **Импорт пакета > настраиваемый пакет**.

    ![Импорт пакета Unity Инсидеаутсфере](images/AzureLabs-Lab6-35.png)

2.  Используйте средство выбора файлов, чтобы выбрать пакет **инсидеаутсфере. пакет unitypackage** , и нажмите кнопку **Открыть**. Отобразится список компонентов для этого актива. Подтвердите импорт, нажав кнопку **Импорт**.

    ![Импорт пакета Unity Инсидеаутсфере](images/AzureLabs-Lab6-36.png)

3.  После завершения импорта вы увидите три новые папки, **материалы**, **модели** и **Prefabs**, добавленные в папку **Assets** . Такой тип структуры папок является типичным для проекта Unity.

    ![Импорт пакета Unity Инсидеаутсфере](images/AzureLabs-Lab6-37.png)

    1.  Откройте папку **Models** , и вы увидите, что модель **инсидеаутсфере** была импортирована.

    2.  В папке **Materials** вы найдете **инсидеаутсферес** Material  *lambert1*, а также материал с именем *буттонматериал*, который используется газебуттон, который вы увидите в ближайшее время.

    3.  Папка **Prefabs** содержит **инсидеаутсфере** prefab, который содержит *модель* **инсидеаутсфере** и *газебуттон*.

    4.  **Код не включается**, вы пишете код, следуя этому курсу.


4.  В **иерархии** выберите **основной объект Camera** и обновите следующие компоненты:

    1.  **Преобразование**

        1.  Положением = **X**: 0, **Y**: 0, **Z**: 0.

        2. Поворот = **X**: 0, **Y**: 0, **Z**: 0.

        3. Масштаб **X**: 1, **Y**: 1, **Z**: 1.

    2.  **Камера**

        1. **Снять флаги**: сплошной цвет.

        2.  **Обтравочные плоскости**: Near: 0,1, дальнее: 6.

            ![Импорт пакета Unity Инсидеаутсфере](images/AzureLabs-Lab6-38.png)

5.  Перейдите в папку **prefab** , а затем перетащите **инсидеаутсфере** prefab на панель **Иерархия** .

    ![Импорт пакета Unity Инсидеаутсфере](images/AzureLabs-Lab6-39.png)

6.  Разверните объект **инсидеаутсфере** в **иерархии** , щелкнув маленькую стрелку рядом с ней. Вы увидите **дочерний** объект под ним под названием **газебуттон**. Это будет использоваться для изменения сцен и, таким как, видео.

    ![Импорт пакета Unity Инсидеаутсфере](images/AzureLabs-Lab6-40.png)

7.  В окне инспектора щелкните компонент преобразования **инсидеаутсфере**, убедитесь, что установлены следующие свойства:

    |            |    TRANSFORM-ПОЗИЦИОНИРОВАНИЕ   |           |
    | :---------:| :-----------------------: | :--------:|
    |   **X** 0  |          **Y** 0          |  **Z** 0  |

    |            |    ПОВОРОТ ПРЕОБРАЗОВАНИЯ   |           |
    | :---------:| :-----------------------: | :--------:|
    |   **X** 0  |          **Y** -50        |  **Z** 0  |

    |            |     ПРЕОБРАЗОВАНИЕ — МАСШТАБИРОВАНИЕ     |           |
    | :---------:| :-----------------------: | :--------:|
    |  **X** 1   |          **Y** 1          |  **Z** 1  |

    ![Импорт пакета Unity Инсидеаутсфере](images/AzureLabs-Lab6-41.png)

8.  Щелкните дочерний объект **газебуттон** и задайте его **Преобразование** следующим образом:

    |            |    TRANSFORM-ПОЗИЦИОНИРОВАНИЕ   |           |
    | :---------:| :-----------------------: | :--------:|
    |   **X** 3,6|          **Y** 1,3        |  **Z** 0  |

    |            |    ПОВОРОТ ПРЕОБРАЗОВАНИЯ   |           |
    | :---------:| :-----------------------: | :--------:|
    |   **X** 0  |          **Y** 0          |  **Z** 0  |

    |            |     ПРЕОБРАЗОВАНИЕ — МАСШТАБИРОВАНИЕ     |           |
    | :---------:| :-----------------------: | :--------:|
    |  **X** 1   |          **Y** 1          |  **Z** 1  |

    ![Импорт пакета Unity Инсидеаутсфере](images/AzureLabs-Lab6-42.png)


## <a name="chapter-5---create-the-videocontroller-class"></a>Глава 5. Создание класса видеоконтроллер

Класс **Видеоконтроллер** содержит две конечные точки видео, которые будут использоваться для потоковой передачи содержимого из службы мультимедиа Azure.

Чтобы создать этот класс, сделайте следующее:

1.  Щелкните правой кнопкой мыши **папку Asset**, расположенную на панели **проект** , и выберите пункт **создать > папку**. Назовите папку **Scripts**.

    ![Создание класса видеоконтроллер](images/AzureLabs-Lab6-43.png)

    ![Создание класса видеоконтроллер](images/AzureLabs-Lab6-44.png)

2.  Дважды щелкните папку **Scripts** , чтобы открыть ее.

3.  Щелкните правой кнопкой мыши внутри папки и выберите команду **создать > \# Сценарий C**. Назовите сценарий **Видеоконтроллер**.

    ![Создание класса видеоконтроллер](images/AzureLabs-Lab6-45.png)

4.  Дважды щелкните новый скрипт **Видеоконтроллер** , чтобы открыть его в **Visual Studio 2017.**

    ![Создание класса видеоконтроллер](images/AzureLabs-Lab6-46.png)

5.  Обновите пространства имен в верхней части файла кода следующим образом:

    ```csharp
    using System.Collections;
    using UnityEngine;
    using UnityEngine.SceneManagement;
    using UnityEngine.Video;
    ```

6.  Введите следующие переменные в класс **Видеоконтроллер** вместе с методом **спящего режима ()** :

    ```csharp
        /// <summary> 
        /// Provides Singleton-like behaviour to this class. 
        /// </summary> 
        public static VideoController instance; 
        
        /// <summary> 
        /// Reference to the Camera VideoPlayer Component.
        /// </summary> 
        private VideoPlayer videoPlayer; 
        
        /// <summary>
        /// Reference to the Camera AudioSource Component.
        /// </summary> 
        private AudioSource audioSource; 
        
        /// <summary> 
        /// Reference to the texture used to project the video streaming 
        /// </summary> 
        private RenderTexture videoStreamRenderTexture;

        /// <summary>
        /// Insert here the first video endpoint
        /// </summary>
        private string video1endpoint = "-- Insert video 1 Endpoint here --";

        /// <summary>
        /// Insert here the second video endpoint
        /// </summary>
        private string video2endpoint = "-- Insert video 2 Endpoint here --";

        /// <summary> 
        /// Reference to the Inside-Out Sphere. 
        /// </summary> 
        public GameObject sphere;

        void Awake()
        {
            instance = this;
        }
    ```

7.  Теперь пора ввести конечные точки из видео службы мультимедиа Azure:

    1.  Первый объект в переменной *video1endpoint* .
    
    2.  Второй объект в переменной *video2endpoint* .

    > [!WARNING]
    > Существует известная ошибка, связанная с использованием *протокола HTTPS* в Unity с версией 2017.4.1 F1. Если видео выдает ошибку при воспроизведении, попробуйте использовать вместо него "http".

8.  Затем необходимо изменить метод **Start ()** . Этот метод будет запускаться каждый раз, когда пользователь переключает сцену (в результате переключается видео) с помощью кнопки "Взгляните".

    ```csharp
        // Use this for initialization
        void Start()
        {
            Application.runInBackground = true;
            StartCoroutine(PlayVideo());
        }
    ```

9.  После метода **Start ()** вставьте метод **PlayVideo ()** *IEnumerator* , который будет использоваться для легкого запуска видео (Поэтому перебои не отображается).

    ```csharp
        private IEnumerator PlayVideo()
        {
            // create a new render texture to display the video 
            videoStreamRenderTexture = new RenderTexture(2160, 1440, 32, RenderTextureFormat.ARGB32);

            videoStreamRenderTexture.Create();

            // assign the render texture to the object material 
            Material sphereMaterial = sphere.GetComponent<Renderer>().sharedMaterial;

            //create a VideoPlayer component 
            videoPlayer = gameObject.AddComponent<VideoPlayer>();

            // Set the video to loop. 
            videoPlayer.isLooping = true;

            // Set the VideoPlayer component to play the video from the texture 
            videoPlayer.renderMode = VideoRenderMode.RenderTexture;

            videoPlayer.targetTexture = videoStreamRenderTexture;

            // Add AudioSource 
            audioSource = gameObject.AddComponent<AudioSource>();

            // Pause Audio play on Awake 
            audioSource.playOnAwake = true;
            audioSource.Pause();

            // Set Audio Output to AudioSource 
            videoPlayer.audioOutputMode = VideoAudioOutputMode.AudioSource;
            videoPlayer.source = VideoSource.Url;

            // Assign the Audio from Video to AudioSource to be played 
            videoPlayer.EnableAudioTrack(0, true);
            videoPlayer.SetTargetAudioSource(0, audioSource);

            // Assign the video Url depending on the current scene 
            switch (SceneManager.GetActiveScene().name)
            {
                case "VideoScene1":
                    videoPlayer.url = video1endpoint;
                    break;

                case "VideoScene2":
                    videoPlayer.url = video2endpoint;
                    break;

                default:
                    break;
            }

            //Set video To Play then prepare Audio to prevent Buffering 
            videoPlayer.Prepare();

            while (!videoPlayer.isPrepared)
            {
                yield return null;
            }

            sphereMaterial.mainTexture = videoStreamRenderTexture;

            //Play Video 
            videoPlayer.Play();

            //Play Sound 
            audioSource.Play();

            while (videoPlayer.isPlaying)
            {
                yield return null;
            }
        }
    ```

10. Последний метод, необходимый для этого класса, — это метод **чанжесцене ()** , который будет использоваться для переключения между сценами.

    ```csharp
        public void ChangeScene()
        {
            SceneManager.LoadScene(SceneManager.GetActiveScene().name == "VideoScene1" ? "VideoScene2" : "VideoScene1");
        }
    ```

    > [!TIP] 
    > Метод **чанжесцене ()** использует удобный \# компонент C, называемый *условным оператором*. Это позволяет проверять условия, а затем значения, возвращаемые в зависимости от результата проверки, в пределах одной инструкции. [Чтобы узнать больше об условном операторе](/dotnet/csharp/language-reference/operators/conditional-operator), перейдите по этой ссылке.

11. Сохраните изменения в Visual Studio перед возвратом в Unity.

12. В редакторе Unity щелкните и перетащите класс **Видеоконтроллер** [from] {. подчеркнутый} в папку **Scripts** для **основного объекта Camera** на панели **Иерархия** .

13. Щелкните **основную камеру** и посмотрите на **Панель инспектора**. Вы заметите, что в вновь добавленном компоненте скрипта есть поле с пустым значением. Это ссылочное поле, которое предназначено для открытых переменных в коде.

14. Перетащите объект **инсидеаутсфере** с **панели Иерархия** в область **Сфера** , как показано на рисунке ниже.

    ![Создание класса видеоконтроллер ](images/AzureLabs-Lab6-47.png)
     ![ Создание класса видеоконтроллер](images/AzureLabs-Lab6-48.png)

## <a name="chapter-6---create-the-gaze-class"></a>Глава 6. Создание класса «взгляд»

Этот класс отвечает за создание **райкаст** , который будет проецирован вперед с **основной камеры** для определения объекта, на котором пользователь смотрит. В этом случае **райкаст** потребуется выяснить, просматривает ли пользователь объект **газебуттон** в сцене и инициирует поведение.

Чтобы создать этот класс, сделайте следующее:

1.  Перейдите к созданной ранее папке **Scripts** .

2.  Щелкните правой кнопкой мыши на панели **проекта** , **Создайте* * C \# script * *. Присвойте скрипту имя « **взгляд**».

3.  Дважды щелкните новый скрипт " **_Взгляните_*_", чтобы открыть его с помощью _* Visual Studio 2017.**

4.  Убедитесь, что в начале скрипта находится следующее пространство имен, и удалите все остальные:

    ```csharp
    using UnityEngine;
    ```

5.  Затем добавьте следующие переменные в класс **Взгляните** :

    ```csharp
        /// <summary> 
        /// Provides Singleton-like behaviour to this class. 
        /// </summary> 
        public static Gaze instance;

        /// <summary> 
        /// Provides a reference to the object the user is currently looking at. 
        /// </summary> 
        public GameObject FocusedGameObject { get; private set; }

        /// <summary> 
        /// Provides a reference to compare whether the user is still looking at 
        /// the same object (and has not looked away). 
        /// </summary> 
        private GameObject oldFocusedObject = null;

        /// <summary> 
        /// Max Ray Distance 
        /// </summary> 
        float gazeMaxDistance = 300;

        /// <summary> 
        /// Provides whether an object has been successfully hit by the raycast. 
        /// </summary> 
        public bool Hit { get; private set; }
    ```

6.  Теперь необходимо добавить код для методов **спящего режима ()** и **Start ()** .

    ```csharp
        private void Awake()
        {
            // Set this class to behave similar to singleton 
            instance = this;
        }

        void Start()
        {
            FocusedGameObject = null;
        }
    ```

7.  Добавьте следующий код в метод **Update ()** для проецирования райкаст и обнаружения попадания целевого объекта:

    ```csharp
        void Update()
        {
            // Set the old focused gameobject. 
            oldFocusedObject = FocusedGameObject;
            RaycastHit hitInfo;

            // Initialise Raycasting. 
            Hit = Physics.Raycast(Camera.main.transform.position, Camera.main.transform.forward, out hitInfo, gazeMaxDistance);

            // Check whether raycast has hit. 
            if (Hit == true)
            {
                // Check whether the hit has a collider. 
                if (hitInfo.collider != null)
                {
                    // Set the focused object with what the user just looked at. 
                    FocusedGameObject = hitInfo.collider.gameObject;
                }
                else
                {
                    // Object looked on is not valid, set focused gameobject to null. 
                    FocusedGameObject = null;
                }
            }
            else
            {
                // No object looked upon, set focused gameobject to null.
                FocusedGameObject = null;
            }

            // Check whether the previous focused object is this same 
            // object (so to stop spamming of function). 
            if (FocusedGameObject != oldFocusedObject)
            {
                // Compare whether the new Focused Object has the desired tag we set previously. 
                if (FocusedGameObject.CompareTag("GazeButton"))
                {
                    FocusedGameObject.SetActive(false);
                    VideoController.instance.ChangeScene();
                }
            }
        }
    ```

8.  Сохраните изменения в Visual Studio перед возвратом в Unity.

9.  Щелкните и **Перетащите класс «указатель» из** папки «скрипты» в основной объект Camera на панели « **Иерархия** ».

## <a name="chapter-7---setup-the-two-unity-scenes"></a>Глава 7. Настройка двух сцен Unity

Целью этой главы является настройка двух сцен, каждый из которых размещает видео в потоке. Вы создадите уже созданную сцену, поэтому вам больше не нужно настраивать ее, хотя вы измените новую сцену, чтобы объект *газебуттон* настроился в другом расположении и имел другой внешний вид. Это показывает, как изменить между сценами.

1.  Для этого перейдите в **файл > сохранить сцену как...**. Появится окно сохранения. Нажмите кнопку **создать папку** .

    ![Глава 7. Настройка двух сцен Unity](images/AzureLabs-Lab6-49.png)

2.  Присвойте папке имя " **сцены**".

3.  Окно **сохранить сцену** по-прежнему будет открыто. Откройте только что созданную папку **сцен** .

4.  В текстовом поле **имя файла** введите **VideoScene1**, а затем нажмите кнопку **сохранить**.

5.  Вернувшись в Unity, откройте папку **сцены** и щелкните файл **VideoScene1** левой кнопкой мыши. Используйте клавиатуру и нажмите клавиши **CTRL + D** , чтобы дублировать сцену

    > [!TIP]
    > **Повторяющуюся** команду также можно выполнить, перейдя в **Edit > дублировать**.

6.  Unity автоматически увеличит номер названия сцены, но проверьте его все равно, чтобы убедиться, что он соответствует ранее вставленному коду.

    >  У вас должны быть **VideoScene1** и **VideoScene2**.

7.  В двух сценах перейдите в раздел **файл > параметры сборки**. Открыв окно **параметры сборки** , перетащите фоновый кадр в раздел **сцены в сборке** .

    ![Глава 7. Настройка двух сцен Unity](images/AzureLabs-Lab6-50.png)

    > [!TIP] 
    > Вы можете выбрать оба монтажных кадра из папки « **сцены** », удерживая нажатой **клавишу CTRL** , а затем выделив каждую из них левой кнопкой мыши, и, наконец, перетащите обе эти сцены.

8.  Закройте окно " **параметры сборки** " и дважды щелкните **VideoScene2**.

9.  После открытия второй сцены щелкните дочерний объект **газебуттон** объекта **инсидеаутсфере** и задайте его преобразование следующим образом:

    |            |    TRANSFORM-ПОЗИЦИОНИРОВАНИЕ   |           |
    | :---------:| :-----------------------: | :--------:|
    |   **X** 0  |         **Y** 1,3         | **Z** 3,6 |

    |            |    ПОВОРОТ ПРЕОБРАЗОВАНИЯ   |           |
    | :---------:| :-----------------------: | :--------:|
    |   **X** 0  |          **Y** 0          |  **Z** 0  |

    |            |     ПРЕОБРАЗОВАНИЕ — МАСШТАБИРОВАНИЕ     |           |
    | :---------:| :-----------------------: | :--------:|
    |  **X** 1   |          **Y** 1          |  **Z** 1  |

10. Если дочерний элемент **газебуттон** все еще выбран, Взгляните на **инспектор** и **Фильтр сетки**. Щелкните небольшое целевое поле рядом с полем ссылка на **сетку** :

    ![Глава 7. Настройка двух сцен Unity](images/AzureLabs-Lab6-51.png)

11. Появится всплывающее окно **Выбор сетки** . Дважды щелкните сетку **куба** в списке **ресурсов**.

    ![Глава 7. Настройка двух сцен Unity](images/AzureLabs-Lab6-52.png)

12. **Фильтр сетки** будет обновлен и теперь станет **кубом**. Теперь щелкните значок **шестеренки** рядом с полем " **Сфера** ", а затем щелкните **удалить компонент**, чтобы удалить его из этого объекта.

    ![Глава 7. Настройка двух сцен Unity](images/AzureLabs-Lab6-53.png)

13. Выбрав **газебуттон** , нажмите кнопку **Добавить компонент** в нижней части **инспектора**. В поле поиска введите **Box**, а в поле " **конфликт"** будет выбран параметр, чтобы добавить в объект **газебуттон** **рамку** .

    ![Глава 7. Настройка двух сцен Unity](images/AzureLabs-Lab6-54.png)

14. **Газебуттон** теперь частично обновляется, чтобы выглядеть иначе, вы создадите новый **материал**, чтобы он полностью отличался, и проще распознать его как другой объект, чем объект в первой сцене.

15. Перейдите в папку « **материалы** » на **панели «проект»**. Дублировать материал **буттонматериал** (нажмите клавиши **CTRL**  +  **D** на клавиатуре или щелкните его левой кнопкой мыши , а затем в меню **изменить** файл выберите пункт **дублировать**).

    ![Глава 7. Настройка двух сцен Unity. ](images/AzureLabs-Lab6-55.png)
     ![ глава 7. Настройка двух сцен Unity](images/AzureLabs-Lab6-56.png)

16. Выберите новый материал **буттонматериал** (под названием **буттонматериал 1**) и в **инспекторе** щелкните окно цвета **албедо** . Появится всплывающее окно, где можно выбрать другой цвет (выберите любой из них), а затем закрыть всплывающее окно. Материал будет его собственным экземпляром и отличаться от исходного.

    ![Глава 7. Настройка двух сцен Unity](images/AzureLabs-Lab6-57.png)

17. Перетащите новый **материал** на дочерний элемент **газебуттон** , чтобы полностью обновить его внешний вид, чтобы его можно было легко отличать от первой кнопки сцены.

    ![Глава 7. Настройка двух сцен Unity](images/AzureLabs-Lab6-58.png)

18. На этом этапе можно протестировать проект в редакторе перед созданием проекта UWP.

    -  Нажмите кнопку **Воспроизведение** в **редакторе** и обменяйте гарнитуру.

        ![Глава 7. Настройка двух сцен Unity](images/AzureLabs-Lab6-59.png)

19. Взгляните на два объекта **газебуттон** для переключения между первым и вторым видео.

## <a name="chapter-8---build-the-uwp-solution"></a>Глава 8. Создание решения UWP

После проверки того, что в редакторе нет ошибок, можно приступать к сборке.

Для сборки:

1.  Сохраните текущую сцену, щелкнув **файл > сохранить**.

2.  Установите флажок **\# проекты Unity C** (это важно, так как он позволит изменять классы после завершения сборки).

3.  Последовательно выберите **файл > параметры сборки**, щелкните **Сборка**.

4.  Вам будет предложено выбрать папку, в которой нужно построить решение.

5.  Создайте папку **Builds** и в этой папке создайте другую папку с соответствующим именем по своему усмотрению.

6.  Щелкните новую папку, а затем выберите пункт **выбрать папку**, чтобы выбрать эту папку, чтобы начать сборку в этом расположении.

    ![Глава 8-Создание решения UWP ](images/AzureLabs-Lab6-60.png)
     ![ глава 8 — Создание решения UWP](images/AzureLabs-Lab6-61.png)

7.  После завершения сборки Unity (может занять некоторое время) он откроет окно **проводника** в расположении сборки.

## <a name="chapter-9---deploy-on-local-machine"></a>Глава 9. развертывание на локальном компьютере

После завершения сборки в расположение сборки появится окно **проводника файлов** . Откройте папку с именем и построением, а затем дважды щелкните файл решения (SLN) в этой папке, чтобы открыть решение с помощью Visual Studio 2017.

Осталось всего лишь развернуть приложение на компьютере (или на *локальном компьютере*).

Чтобы выполнить развертывание на локальном компьютере, выполните следующие действия.

1.  В **Visual Studio 2017** откройте только что созданный файл решения.

2.  На **платформе решения** выберите **x86, локальный компьютер**.

3.  В **конфигурации решения** выберите **Отладка**.

    ![Глава 9--развертывание на локальном компьютере](images/AzureLabs-Lab6-62.png)

4.  Теперь необходимо восстановить все пакеты в решении. Щелкните **решение** правой кнопкой мыши и выберите команду **восстановить пакеты NuGet для решения...**

    > [!NOTE] 
    > Это делается потому, что пакеты, для которых построен Unity должен быть предназначен для работы со ссылками на локальные компьютеры.

5.  Перейдите в **меню "сборка** " и щелкните " **Развернуть решение** ", чтобы загружать неопубликованные приложение на компьютере. Visual Studio сначала построит и развернет приложение.

6.  Теперь приложение должно отобразиться в списке установленных приложений, готовых к запуску.

    ![Глава 9--развертывание на локальном компьютере](images/AzureLabs-Lab6-63.png)

При запуске приложения Mixed Reality вы будете находиться в модели **инсидеаутсфере** , используемой в приложении. Эта сфера будет использоваться для потоковой передачи видео, предоставляя представление в 360 градусов для входящего видео (которое было на пленке для этого типа перспективы). Не удивит, если видео занимает несколько секунд для загрузки, ваше приложение зависит от доступной скорости Интернета, так как требуется получить и загрузить видео, чтобы выполнить потоковую передачу в приложение.
Когда вы будете готовы, измените сцены и откройте второе видео, облаками на красную шар! Затем вы можете вернуться назад, используя синий куб во второй сцене!

## <a name="your-finished-azure-media-service-application"></a>Законченное приложение службы мультимедиа Azure
 
Поздравляем! вы создали приложение смешанной реальности, которое использует службу мультимедиа Azure для потоковой передачи видео 360.

![результат лаборатории](images/AzureLabs-Lab6-00.png)

![результат лаборатории](images/AzureLabs-Lab6-01.png)

## <a name="bonus-exercises"></a>Премиальные упражнения

**Упражнение 1**

Для изменения видео в рамках этого руководства можно использовать только одну сцену. Поэкспериментируйте с приложением и сделайте его одним монтажным кадром! Возможно, даже добавить еще одно видео в набор.

**Упражнение 2**

Поэкспериментируйте с Azure и Unity и попытайтесь реализовать возможность приложения автоматически выбирать видео с другим размером файла в зависимости от надежности подключения к Интернету.