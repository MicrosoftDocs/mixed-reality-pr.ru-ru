---
title: Пространственные привязки Azure в Unreal
description: Общие сведения о создании пространственных привязок Azure в движке Unreal.
author: hferrone
ms.author: v-hferrone
ms.date: 07/01/2020
ms.topic: tutorial
ms.localizationpriority: high
keywords: Unreal, Unreal Engine 4, UE4, HoloLens 2, Azure, разработка Azure, пространственные привязки, смешанная реальность, разработка, функции, новый проект, эмулятор, документация, руководства, голограммы, разработка игр, гарнитура смешанной реальности, гарнитура Windows Mixed Reality, гарнитура виртуальной реальности
ms.openlocfilehash: 05a4b221961fa9b3a150eb8ef9f8bd2f77f5b955
ms.sourcegitcommit: dd13a32a5bb90bd53eeeea8214cd5384d7b9ef76
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/17/2020
ms.locfileid: "94679873"
---
# <a name="azure-spatial-anchors-in-unreal"></a>Пространственные привязки Azure в Unreal

## <a name="overview"></a>Обзор

Пространственные привязки Azure — это служба Microsoft Mixed Reality, позволяющая устройствам дополненной реальности обнаруживать, публиковать и сохранять точки привязок в физическом мире. В документации ниже приведены инструкции по интеграции службы "Пространственные привязки Azure" в проект Unreal. Дополнительные сведения см. на странице [службы "Пространственные привязки Azure"](https://azure.microsoft.com/services/spatial-anchors/).

> [!IMPORTANT]
> Локальные привязки хранятся на устройстве, а пространственные привязки Azure сохраняются в облаке. Если вам нужно хранить привязки локально на устройстве, соответствующие инструкции приведены в документе по [локальным пространственным привязкам](unreal-spatial-anchors.md). Обратите внимание, что вы можете использовать локальные привязки и привязки Azure в одном проекте без каких-либо конфликтов.

## <a name="prerequisites"></a>Предварительные условия

Для работы с этим руководством вам потребуются:

- [Unreal 4.25](https://www.unrealengine.com/get-now) или более поздней версии;
- настройка [проекта HoloLens 2](tutorials/unreal-uxt-ch1.md) в Unreal; 
- ознакомление с [обзором пространственных привязок Azure](https://docs.microsoft.com/azure/spatial-anchors/overview);
- базовые знания C++ и Unreal.

## <a name="getting-azure-spatial-anchors-account-info"></a>Получение сведений об учетной записи службы "Пространственные привязки Azure"

Прежде чем вы сможете использовать Пространственные привязки Azure в своем проекте, сделайте следующее:
* [Создайте ресурс пространственных привязок](https://docs.microsoft.com/azure/spatial-anchors/quickstarts/get-started-hololens#create-a-spatial-anchors-resource) и скопируйте приведенные ниже поля учетной записи. Эти значения используются для аутентификации пользователей в учетной записи приложения:
    * **идентификатор учетной записи**;
    * **ключ учетной записи**.

Дополнительные сведения см. в документации по [аутентификации в службе "Пространственные привязки Azure"](https://docs.microsoft.com/azure/spatial-anchors/concepts/authentication?tabs=csharp).

> [!NOTE]
> Пространственные привязки Azure в Unreal 4.25 не поддерживают маркеры аутентификации Azure AD, но мы добавим поддержку такой функции в последующих выпусках.

## <a name="adding-azure-spatial-anchors-plugins"></a>Добавление подключаемых модулей службы "Пространственные привязки Azure"

Включите подключаемые модули службы "Пространственные привязки Azure" в Unreal Editor, выполнив следующие действия:
1. Последовательно выберите элементы **Edit (Правка) > Plugins (Подключаемые модули)** и найдите модули **AzureSpatialAnchors** и **AzureSpatialAnchorsForWMR**.
2. Установите флажок **Enabled** (Включен) для обоих модулей, чтобы разрешить доступ к библиотекам схем Пространственных привязок Azure в своем приложении.

![Подключаемые модули Пространственных привязок](images/asa-unreal/unreal-spatial-anchors-img-01.png)

После этого перезапустите Unreal Editor, чтобы изменения вступили в силу. Теперь проект готов к использованию Пространственных привязок Azure.

## <a name="starting-a-spatial-anchors-session"></a>Запуск сеанса Пространственных привязок
Сеанс Пространственных привязок Azure позволяет клиентским приложениям взаимодействовать со службой "Пространственные привязки Azure". Вам нужно будет создать и запустить сеанс службы "Пространственные привязки Azure" для создания, сохранения и публикации пространственных привязок Azure:

1. Откройте схему для Pawn, используемого в приложении.
2. Добавьте две строковые переменные для **идентификатора учетной записи** и **ключа учетной записи**. Назначьте соответствующие значения из учетной записи службы "Пространственные привязки Azure", чтобы аутентифицировать сеанс.

![Подключаемые модули Пространственных привязок](images/asa-unreal/unreal-spatial-anchors-img-02.png)

Запустите сеанс Пространственных привязок Azure, выполнив следующие действия:
1. Проверьте, что **сеанс дополненной реальности** запущен в приложении HoloLens, так как сеанс Пространственных привязок Azure не может запуститься без сеанса дополненной реальности. Если у вас нет единой настройки, [создайте ресурс сеанса дополненной реальности](https://docs.microsoft.com/windows/mixed-reality/unreal-uxt-ch3#adding-the-session-asset).
2. Добавьте пользовательское событие **Start Azure Spatial Anchors Session** (Запуск сеанса Пространственных привязок Azure) и настройте его, как показано на снимке экрана ниже.
    * При создании сеанса он не будет запущен по умолчанию. Это позволяет разработчику настроить сеанс для аутентификации со службой "Пространственные привязки Azure".

![Подключаемые модули Пространственных привязок](images/asa-unreal/unreal-spatial-anchors-img-03.png)

3. Настройте сеанс Пространственных привязок Azure, чтобы предоставить **идентификатор** и **ключ учетной записи**.

![Подключаемые модули Пространственных привязок](images/asa-unreal/unreal-spatial-anchors-img-04.png)

4. Запустите сеанс Пространственных привязок Azure, разрешив приложению создавать и находить пространственные привязки Azure.

![Подключаемые модули Пространственных привязок](images/asa-unreal/unreal-spatial-anchors-img-05.png)

Рекомендуется очистить ресурсы Пространственных привязок Azure в схеме графа событий, если вы больше не используете службу:

1. Остановите сеанс Пространственных привязок Azure. Сеанс больше не будет выполняться, но связанные с ним ресурсы по-прежнему будут существовать в подключаемом модуле Пространственных привязок Azure.

![Подключаемые модули Пространственных привязок](images/asa-unreal/unreal-spatial-anchors-img-06.png)

2. Удалите сеанс Пространственных привязок Azure, чтобы очистить все его ресурсы, о которых еще известно подключаемому модулю Пространственных привязок Azure.

![Подключаемые модули Пространственных привязок](images/asa-unreal/unreal-spatial-anchors-img-07.png)

Схема графа событий должна выглядеть так, как показано на снимке экрана ниже:

![Подключаемые модули Пространственных привязок](images/asa-unreal/unreal-spatial-anchors-img-08.png)


## <a name="creating-an-anchor"></a>Создание привязки
Пространственная привязка Azure — это точка физического мира в пространстве приложения дополненной реальности, которая связывает содержимое дополненной реальности с расположениями в физическом мире. Пространственные привязки Azure могут совместно использовать различные пользователи. Такой общий доступ позволяет размещать содержимое дополненной реальности, отображаемое на различных устройствах, в одном расположении физического мира. 

Чтобы создать новую пространственную привязку Azure, выполните следующие действия:
1. Убедитесь, что сеанс Пространственных привязок Azure запущен. Приложение не сможет создать или сохранить пространственную привязку Azure, если сеанс Пространственных привязок Azure не запущен.

![Подключаемые модули Пространственных привязок](images/asa-unreal/unreal-spatial-anchors-img-09.png)

2. Создайте или получите **[компонент Scene (Сцена)](https://docs.unrealengine.com/API/Runtime/Engine/Components/USceneComponent/index.html)** Unreal, расположение которого должно быть сохранено. 
    * На изображении ниже **Scene Component Needing Anchor** (Компонент Scene, нуждающийся в привязке) используется в качестве переменной. Компонент Unreal Scene (Сцена) необходим, чтобы сформировать преобразование мира приложения для [маркера дополненной реальности](https://docs.unrealengine.com/BlueprintAPI/HoloLensAR/ARPin/index.html) и пространственной привязки Azure.

![Подключаемые модули Пространственных привязок](images/asa-unreal/unreal-spatial-anchors-img-10.png)

Чтобы создать и сохранить пространственную привязку Azure для компонента Unreal Scene (Сцена), выполните следующие действия:
1. Вызовите [компонент Pin (Маркер)](https://docs.unrealengine.com/BlueprintAPI/ARAugmentedReality/Pin/PinComponent/index.html) для компонента Unreal Scene (Сцена) и укажите его **World Transform** (Преобразование мира) в качестве преобразования мира для маркера дополненной реальности.
    * Unreal отслеживает точки дополненной реальности в пространстве приложения с помощью маркеров дополненной реальности, которые используются для создания пространственной привязки Azure. В Unreal маркер дополненной реальности аналогичен объекту SpatialAnchor в HoloLens.

![Подключаемые модули Пространственных привязок](images/asa-unreal/unreal-spatial-anchors-img-11.png)

2. Вызовите функцию **Create Cloud Anchor** (Создание облачной привязки) с помощью только что созданного маркера дополненной реальности.
    * При создании облачной привязки пространственная привязка Azure создается локально, а не в службе "Пространственные привязки Azure". Параметры для пространственной привязки Azure, например срок ее действия, можно задать до создания пространственной привязки с помощью службы.

![Подключаемые модули Пространственных привязок](images/asa-unreal/unreal-spatial-anchors-img-12.png)

3. Задайте срок действия пространственной привязки Azure. Параметр Lifetime (Время действия) этой функции позволяет разработчикам указать (в секундах), как долго привязка будет поддерживаться службой.
    * Например, срок действия длительностью в неделю будет равен 60 с x 60 мин x 24 ч x 7 дн. = 604 800 с.

![Подключаемые модули Пространственных привязок](images/asa-unreal/unreal-spatial-anchors-img-13.png)

После настройки параметров привязки объявите привязку как готовую к сохранению. В примере ниже только что созданная пространственная привязка Azure добавляется к набору пространственных привязок Azure, которые требуют сохранения. Этот набор объявляется как переменная для схемы Pawn.

![Подключаемые модули Пространственных привязок](images/asa-unreal/unreal-spatial-anchors-img-14.png)

## <a name="saving-an-anchor"></a>Сохранение привязки

После настройки пространственной привязки Azure с вашими параметрами вызовите функцию **Save Cloud Anchor** (Сохранение облачной привязки). Функция Save Cloud Anchor (Сохранение облачной привязки) объявляет привязку для службы "Пространственные привязки Azure". Если вызов к этому действию был успешным, пространственная привязка Azure становится доступна другим пользователям службы "Пространственные привязки Azure".  

![Подключаемые модули Пространственных привязок](images/asa-unreal/unreal-spatial-anchors-img-15.png)

> [!NOTE]
> Save Cloud Anchor (Сохранение облачной привязки) — это асинхронная функция, которую можно вызвать только для события потока игры, например **EventTick**. Save Cloud Anchor может не отображаться как доступная функция схемы в пользовательских функциях схемы, но она также доступна в редакторе схемы графа событий для Pawn.

В приведенном ниже примере пространственная привязка Azure сохраняется в наборе во время обратного вызова входного события. Привязка затем сохраняется в EventTick. Для сохранения пространственной привязки Azure может потребоваться несколько попыток в зависимости от объема пространственных данных, созданных в сеансе Пространственных привязок Azure. Именно поэтому рекомендуется проверять, был ли успешным вызов сохранения.

Если привязка не сохранилась, повторно добавьте ее в набор привязок, требующих сохранения. Последующий поток EventTicks будет пытаться сохранить привязку, пока она не будет успешно передана в службу "Пространственные привязки Azure".

![Подключаемые модули Пространственных привязок](images/asa-unreal/unreal-spatial-anchors-img-16.png)

После сохранения привязки вы можете использовать преобразование маркеров дополненной реальности в качестве эталонного преобразования для размещения содержимого в приложении. Другие пользователи могут обнаружить такую привязку и сопоставить содержимое дополненной реальности для разных устройств в физическом мире.

## <a name="deleting-an-anchor"></a>Удаление привязки

Вы можете удалить привязку из службы "Пространственные привязки Azure", вызвав функцию **Delete Cloud Anchor** (Удаление облачной привязки).

![Подключаемые модули Пространственных привязок](images/asa-unreal/unreal-spatial-anchors-img-17.png)

> [!NOTE]
> Delete Cloud Anchor (Удаление облачной привязки) — это скрытая функция, которую можно вызвать только для события потока игры, например EventTick. Delete Cloud Anchor может не отображаться как доступная функция схемы в пользовательских функциях схемы, но она также доступна в редакторе схемы графа событий для Pawn.

В примере ниже привязка помечается для удаления при пользовательском событии ввода. После этого предпринимается попытка удаления в EventTick. В случае сбоя удаления привязки добавьте пространственную привязку Azure в набор привязок, помеченных для удаления, и повторите попытку в следующих событий EventTick.

Схема графа событий теперь должна выглядеть так, как показано на снимке экрана ниже:

![Подключаемые модули Пространственных привязок](images/asa-unreal/unreal-spatial-anchors-img-18.png)


## <a name="locating-pre-existing-anchors"></a>Поиск существующих привязок

Помимо создания пространственных привязок Azure, вы можете обнаруживать привязки, созданные другими пользователями или устройствами с помощью службы "Пространственные привязки Azure":

1. Получите идентификатор пространственной привязки Azure, которую хотите обнаружить.
    * Идентификатор привязки можно получить для привязки, созданной устройством из предыдущего сеанса Пространственных привязок Azure. Кроме того, его можно создать и использовать совместно с одноранговыми устройствами, взаимодействующими со службой "Пространственные привязки Azure".

![Подключаемые модули Пространственных привязок](images/asa-unreal/unreal-spatial-anchors-img-24.png)

2. Добавьте компонент **AzureSpatialAnchorsEvent** в свою схему Pawn.
    * Этот компонент позволяет вам подписаться на различные события Пространственных привязок Azure, например на события, вызываемые при нахождении пространственной привязки Azure.

![Подключаемые модули Пространственных привязок](images/asa-unreal/unreal-spatial-anchors-img-19.png)

3. Подпишитесь на событие **ASAAnchor Located Delegate** (Привязкой ASAAnchor обнаружен делегат) для компонента **AzureSpatialAnchorsEvent**.
    * Делегат сообщает приложению об обнаружении новых привязок, связанных с учетной записью Пространственных привязок Azure.
    * При обратном вызове события пространственные привязки Azure, созданные другими пользователями или устройствами с помощью сеанса Пространственных привязок Azure, по умолчанию не будут включать маркеры дополненной реальности. Чтобы создать маркер дополненной реальности для обнаруженной пространственной привязки Azure, разработчики могут вызвать функцию **Create ARPin Around Azure Cloud Spatial Anchor** (Создание маркера дополненной реальности в облачной пространственной привязке Azure).

![Подключаемые модули Пространственных привязок](images/asa-unreal/unreal-spatial-anchors-img-20.png)

Чтобы найти пространственные привязки Azure, созданные другими пользователями или устройствами с помощью службы "Пространственные привязки Azure", приложению нужно создать **наблюдатель за пространственными привязками Azure**:
1. Убедитесь, что сеанс Пространственных привязок Azure запущен.
2. Создайте **AzureSpatialAnchorsLocateCriteria**.
    * Вы можете указать различные параметры расположения, например расстояние от пользователя или от другой привязки.
3. Объявите идентификатор нужной пространственной привязки Azure в **AzureSpatialAnchorsLocateCriteria**.
4. Вызовите функцию **Create Watcher** (Создание наблюдателя).

![Подключаемые модули Пространственных привязок](images/asa-unreal/unreal-spatial-anchors-img-21.png)

Приложение теперь начнет поиск пространственных привязок Azure, о которых известно службе "Пространственные привязки Azure", благодаря чему пользователи смогут находить пространственные привязки Azure, созданные другими.

После обнаружения пространственной привязки Azure вызовите функцию **Stop Watcher** (Остановка наблюдателя), чтобы остановить наблюдатель за пространственными привязками Azure и очистить его ресурсы.

![Подключаемые модули Пространственных привязок](images/asa-unreal/unreal-spatial-anchors-img-22.png)

Финальная схема графа событий теперь должна выглядеть так, как показано на снимке экрана ниже:

![Подключаемые модули Пространственных привязок](images/asa-unreal/unreal-spatial-anchors-img-23.png)

## <a name="next-development-checkpoint"></a>Следующий этап разработки

Если вы следуете изложенным нами этапам разработки для Unreal, вы как раз прошли половину в изучении основных стандартных блоков MRTK. Отсюда вы можете перейти к следующему стандартному блоку: 

> [!div class="nextstepaction"]
> [Пространственное сопоставление](unreal-spatial-mapping.md)

Или перейдите к возможностям и API платформы смешанной реальности:

> [!div class="nextstepaction"]
> [Камера HoloLens](unreal-hololens-camera.md)

Вы можете в любой момент вернуться к [этапам разработки для Unreal](unreal-development-overview.md#2-core-building-blocks).


## <a name="next-steps"></a>Дальнейшие действия
* [Локальные пространственные привязки](unreal-spatial-anchors.md)
* [Документация по пространственным привязкам](https://docs.microsoft.com/azure/spatial-anchors/)
* [Функции пространственных привязок](https://azure.microsoft.com/services/spatial-anchors/#features)
* [Действующие рекомендации по работе с привязками](https://docs.microsoft.com/azure/spatial-anchors/concepts/guidelines-effective-anchor-experiences)