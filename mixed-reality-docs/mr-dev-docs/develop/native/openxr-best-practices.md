---
title: Рекомендации по работе с OpenXR
description: Ознакомьтесь с рекомендациями по повышению качества, стабильности и производительности приложений Опенкср.
author: thetuvix
ms.author: alexturn
ms.date: 2/28/2020
ms.topic: article
keywords: Опенкср, Кхронос, Басикксрапп, DirectX, Native, собственное приложение, настраиваемое ядро, по промежуточного слоя, рекомендации, производительность, качество, стабильность
ms.openlocfilehash: dad4622e4186ecc8b090e2abe2e33d3d39ac7525
ms.sourcegitcommit: 09599b4034be825e4536eeb9566968afd021d5f3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/03/2020
ms.locfileid: "91691501"
---
# <a name="openxr-app-best-practices"></a><span data-ttu-id="7fcbf-104">Рекомендации по приложениям Опенкср</span><span class="sxs-lookup"><span data-stu-id="7fcbf-104">OpenXR app best practices</span></span>

<span data-ttu-id="7fcbf-105">Ниже приведены примеры лучших методов в файле Опенксрпрограм. cpp для <a href="https://github.com/microsoft/OpenXR-MixedReality/tree/master/samples/BasicXrApp" target="_blank">басикксрапп</a>.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-105">You can see an example of the best practices below in <a href="https://github.com/microsoft/OpenXR-MixedReality/tree/master/samples/BasicXrApp" target="_blank">BasicXrApp</a>'s OpenXRProgram.cpp file.</span></span> <span data-ttu-id="7fcbf-106">Функция Run () в начале фиксирует типичный поток кода приложения Опенкср из инициализации в цикле событий и отрисовки.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-106">The Run() function at the beginning captures a typical OpenXR app code flow from initialization to the event and rendering loop.</span></span>

## <a name="best-practices-for-visual-quality-and-stability"></a><span data-ttu-id="7fcbf-107">Рекомендации по качеству и стабильности визуального элемента</span><span class="sxs-lookup"><span data-stu-id="7fcbf-107">Best practices for visual quality and stability</span></span>

<span data-ttu-id="7fcbf-108">Рекомендации в этом разделе описывают, как получить лучшее визуальное качество и стабильность в любом приложении Опенкср.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-108">The best practices in this section describe how to get the best visual quality and stability in any OpenXR application.</span></span>

<span data-ttu-id="7fcbf-109">Дополнительные рекомендации по производительности, относящиеся к HoloLens 2, см. в разделе рекомендации по [производительности в hololens 2](#best-practices-for-performance-on-hololens-2) ниже.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-109">For further performance recommendations specific to HoloLens 2, see the [Best practices for performance on HoloLens 2](#best-practices-for-performance-on-hololens-2) section below.</span></span>

### <a name="gamma-correct-rendering"></a><span data-ttu-id="7fcbf-110">Гамма-Правильная отрисовка</span><span class="sxs-lookup"><span data-stu-id="7fcbf-110">Gamma-correct rendering</span></span>

<span data-ttu-id="7fcbf-111">Необходимо соблюдать осторожность, чтобы убедиться, что конвейер отрисовки является гамма-правильным.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-111">Care must be taken to ensure that your rendering pipeline is gamma-correct.</span></span> <span data-ttu-id="7fcbf-112">При подготовке к просмотру в имеющуюся цепочку буферов формат представления "Визуализация-целевой объект" должен соответствовать формату имеющуюся цепочку буферов (например `DXGI_FORMAT_B8G8R8A8_UNORM_SRGB` , для формата имеющуюся цепочку буферов и представления целевого объекта визуализации).</span><span class="sxs-lookup"><span data-stu-id="7fcbf-112">When rendering to a swapchain, the render-target view format should match the swapchain format (e.g. `DXGI_FORMAT_B8G8R8A8_UNORM_SRGB` for both the swapchain format and the render-target view).</span></span>
<span data-ttu-id="7fcbf-113">Исключением является ситуация, когда конвейер отрисовки приложения выполняет ручное преобразование sRGB в коде шейдера. в этом случае приложение должно запрашивать формат имеющуюся цепочку буферов sRGB, но использовать линейный формат для представления визуализации-целевого объекта (например, запрос в `DXGI_FORMAT_B8G8R8A8_UNORM_SRGB` формате имеющуюся цепочку буферов, но использовать его в `DXGI_FORMAT_B8G8R8A8_UNORM` качестве представления целевого объекта), чтобы предотвратить исправление содержимого с помощью двойной гаммы.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-113">The exception is if the app's rendering pipeline does a manual sRGB conversion in shader code, in which case the app should request an sRGB swapchain format but use the linear format for the render-target view (e.g. request `DXGI_FORMAT_B8G8R8A8_UNORM_SRGB` as the swapchain format but use `DXGI_FORMAT_B8G8R8A8_UNORM` as the render-target view) to prevent content from being double-gamma corrected.</span></span>

### <a name="submit-depth-buffer-for-projection-layers"></a><span data-ttu-id="7fcbf-114">Отправка буфера глубины для слоев проекции</span><span class="sxs-lookup"><span data-stu-id="7fcbf-114">Submit depth buffer for projection layers</span></span>

<span data-ttu-id="7fcbf-115">Всегда используйте `XR_KHR_composition_layer_depth` расширение и отправьте буфер глубины вместе с слоем проекции при отправке кадра в `xrEndFrame` .</span><span class="sxs-lookup"><span data-stu-id="7fcbf-115">Always use `XR_KHR_composition_layer_depth` extension and submit the depth buffer together with the projection layer when submitting a frame to `xrEndFrame`.</span></span>
<span data-ttu-id="7fcbf-116">Это повышает устойчивость к голограммам за счет повышения глубины оборудования в HoloLens 2.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-116">This improves hologram stability by enabling hardware depth reprojection on HoloLens 2.</span></span>

### <a name="choose-a-reasonable-depth-range"></a><span data-ttu-id="7fcbf-117">Выберите приемлемый диапазон глубины</span><span class="sxs-lookup"><span data-stu-id="7fcbf-117">Choose a reasonable depth range</span></span>

<span data-ttu-id="7fcbf-118">Предпочтительнее использовать более узкий диапазон глубины виртуального содержимого, чтобы повысить стабильность работы HoloLens.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-118">Prefer a narrower depth range to scope the virtual content to help hologram stability on HoloLens.</span></span>
<span data-ttu-id="7fcbf-119">Например, в примере Опенксрпрограм. cpp используется 0,1 – 20 метров.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-119">For example, the OpenXrProgram.cpp sample is using 0.1 to 20 meters.</span></span>
<span data-ttu-id="7fcbf-120">Используйте [Обратный-Z](https://developer.nvidia.com/content/depth-precision-visualized) для более однородного разрешения глубины.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-120">Use [reversed-Z](https://developer.nvidia.com/content/depth-precision-visualized) for a more uniform depth resolution.</span></span>
<span data-ttu-id="7fcbf-121">Обратите внимание, что в HoloLens 2 использование предпочтительного `DXGI_FORMAT_D16_UNORM` формата глубины поможет повысить скорость и производительность кадров, хотя буферы 16-разрядной глубины обеспечивают меньшее разрешение глубины по сравнению с 24-разрядными буферами глубины.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-121">Note that, on HoloLens 2, using the preferred `DXGI_FORMAT_D16_UNORM` depth format will help achieve better frame rate and performance, although 16-bit depth buffers provide less depth resolution than 24-bit depth buffers.</span></span>
<span data-ttu-id="7fcbf-122">Поэтому следует выполнить эти рекомендации, чтобы лучше использовать разрешение глубины.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-122">Therefore, following these best practices to make best use of the depth resolution becomes more important.</span></span>

### <a name="prepare-for-different-environment-blend-modes"></a><span data-ttu-id="7fcbf-123">Подготовка к различным режимам смешения среды</span><span class="sxs-lookup"><span data-stu-id="7fcbf-123">Prepare for different environment blend modes</span></span>

<span data-ttu-id="7fcbf-124">Если приложение также будет работать на впечатляющих гарнитурах, полностью блокирующих мир, обязательно перечислите поддерживаемые режимы наложения среды с помощью `xrEnumerateEnvironmentBlendModes` API и подготовьте содержимое для подготовки к просмотру соответствующим образом.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-124">If your application will also run on immersive headsets that completely block out the world, be sure to enumerate supported environment blend modes using `xrEnumerateEnvironmentBlendModes` API, and prepare your rendering content accordingly.</span></span>
<span data-ttu-id="7fcbf-125">Например, для системы, `XR_ENVIRONMENT_BLEND_MODE_ADDITIVE` такой как HoloLens, приложение должно использовать прозрачность в качестве четкого цвета, а для системы с `XR_ENVIRONMENT_BLEND_MODE_OPAQUE` приложение должно визуализировать непрозрачный цвет или некоторую виртуальную комнату в фоновом режиме.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-125">For example, for a system with `XR_ENVIRONMENT_BLEND_MODE_ADDITIVE` such as the HoloLens, the app should use transparent as the clear color, while for a system with `XR_ENVIRONMENT_BLEND_MODE_OPAQUE`, the app should render some opaque color or some virtual room in the background.</span></span>

### <a name="choose-unbounded-reference-space-as-applications-root-space"></a><span data-ttu-id="7fcbf-126">Выбрать неограниченное пространство ссылок в качестве корневого пространства приложения</span><span class="sxs-lookup"><span data-stu-id="7fcbf-126">Choose unbounded reference space as application's root space</span></span>

<span data-ttu-id="7fcbf-127">Приложения обычно устанавливают некоторое корневое пространство координат для подключения представлений, действий и голограмм.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-127">Applications typically establish some root world coordinate space to connect views, actions and holograms together.</span></span>
<span data-ttu-id="7fcbf-128">Используйте `XR_REFERENCE_SPACE_TYPE_UNBOUNDED_MSFT` , если расширение поддерживается для установления [геометрической системы координат](../../design/coordinate-systems.md#building-a-world-scale-experience), что позволяет приложению избежать нежелательного уменьшения голограммы, когда пользователь перемещается (например, 5 метров) с места запуска приложения.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-128">Use `XR_REFERENCE_SPACE_TYPE_UNBOUNDED_MSFT` when the extension is supported to establish a [world-scale coordinate system](../../design/coordinate-systems.md#building-a-world-scale-experience), enabling your app to avoid undesired hologram drift when the user moves far (e.g. 5 meters away) from where the app starts.</span></span>
<span data-ttu-id="7fcbf-129">Используйте `XR_REFERENCE_SPACE_TYPE_LOCAL` в качестве резервной, если не существует расширения неограниченного пространства.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-129">Use `XR_REFERENCE_SPACE_TYPE_LOCAL` as a fallback if the unbounded space extension doesn't exist.</span></span>

### <a name="associate-hologram-with-spatial-anchor"></a><span data-ttu-id="7fcbf-130">Связать голограмму с пространственной привязкой</span><span class="sxs-lookup"><span data-stu-id="7fcbf-130">Associate hologram with spatial anchor</span></span>

<span data-ttu-id="7fcbf-131">При использовании неограниченного пространства ссылок голограммы, размещенные непосредственно в этом справочном пространстве, [могут быть смещены по мере того, как пользователь переходит к удаленным комнатам, а затем](../../design/coordinate-systems.md#building-a-world-scale-experience)возвращается.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-131">When using an unbounded reference space, holograms you place directly in that reference space [may drift as the user walks to distant rooms and then comes back](../../design/coordinate-systems.md#building-a-world-scale-experience).</span></span>
<span data-ttu-id="7fcbf-132">Для пользователей с голограммами, которые помещаются в дискретное место в мире, [Создайте пространственное привязку](../../design/spatial-anchors.md#best-practices) с помощью `xrCreateSpatialAnchorSpaceMSFT` функции расширения и поместите голограмму на ее начало.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-132">For hologram users place at a discrete location in the world, [create a spatial anchor](../../design/spatial-anchors.md#best-practices) using the `xrCreateSpatialAnchorSpaceMSFT` extension function and position the hologram at its origin.</span></span>
<span data-ttu-id="7fcbf-133">Это обеспечит нестабильную голограмму в зависимости от времени.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-133">That will keep that hologram independently stable over time.</span></span>

### <a name="support-mixed-reality-capture"></a><span data-ttu-id="7fcbf-134">Поддержка записи смешанной реальности</span><span class="sxs-lookup"><span data-stu-id="7fcbf-134">Support mixed reality capture</span></span>

<span data-ttu-id="7fcbf-135">Несмотря на то, что основной дисплей HoloLens 2 использует Аддитивное смешение среды, когда пользователь инициирует [запись смешанной реальности](../platform-capabilities-and-apis/mixed-reality-capture-for-developers.md), содержимое отрисовки приложения будет иметь альфа-смешение с потоком видео среды.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-135">Although HoloLens 2's primary display uses additive environment blending, when the user initiates [mixed reality capture](../platform-capabilities-and-apis/mixed-reality-capture-for-developers.md), the app's rendering content will be alpha-blended with the environment video stream.</span></span>
<span data-ttu-id="7fcbf-136">Для достижения наилучшего визуального качества в видеороликах смешанной реальности лучше установить на `XR_COMPOSITION_LAYER_BLEND_TEXTURE_SOURCE_ALPHA_BIT` уровне проекции `layerFlags` .</span><span class="sxs-lookup"><span data-stu-id="7fcbf-136">To achieve the best visual quality in mixed reality capture videos, it's best to set the `XR_COMPOSITION_LAYER_BLEND_TEXTURE_SOURCE_ALPHA_BIT` in your projection layer's `layerFlags`.</span></span>

## <a name="best-practices-for-performance-on-hololens-2"></a><span data-ttu-id="7fcbf-137">Рекомендации по повышению производительности в HoloLens 2</span><span class="sxs-lookup"><span data-stu-id="7fcbf-137">Best practices for performance on HoloLens 2</span></span>

<span data-ttu-id="7fcbf-138">Как мобильное устройство с поддержкой РЕПРОЕКЦИИ оборудования, HoloLens 2 имеет более четкие требования для достижения оптимальной производительности.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-138">As a mobile device with hardware reprojection support, HoloLens 2 has stricter requirements to obtain optimal performance.</span></span>  <span data-ttu-id="7fcbf-139">Существует несколько способов отправки данных композиции `xrEndFrame` , что приведет к последующей обработке, что приведет к заметному снижению производительности.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-139">There are a number of ways to submit composition data through `xrEndFrame` which will result in post-processing that will have a noticeable performance penalty.</span></span>

### <a name="select-a-swapchain-format"></a><span data-ttu-id="7fcbf-140">Выберите формат имеющуюся цепочку буферов</span><span class="sxs-lookup"><span data-stu-id="7fcbf-140">Select a swapchain format</span></span>

<span data-ttu-id="7fcbf-141">Всегда перечислите Поддерживаемые форматы пикселей с помощью `xrEnumerateSwapchainFormats` , а затем выберите первый цвет и формат пикселей глубины из среды выполнения, которую поддерживает приложение, поскольку среда выполнения предпочитает оптимальную производительность.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-141">Always enumerate supported pixel formats using `xrEnumerateSwapchainFormats`, and choose the first color and depth pixel format from the runtime that the app supports, because that's what the runtime prefers for optimal performance.</span></span> <span data-ttu-id="7fcbf-142">Обратите внимание, что в HoloLens 2 `DXGI_FORMAT_B8G8R8A8_UNORM_SRGB` и `DXGI_FORMAT_D16_UNORM` обычно является первым выбором для достижения лучшей производительности отрисовки.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-142">Note, on HoloLens 2, `DXGI_FORMAT_B8G8R8A8_UNORM_SRGB` and `DXGI_FORMAT_D16_UNORM` is typically the first choice to achieve better rendering performance.</span></span> <span data-ttu-id="7fcbf-143">Этот параметр может отличаться на гарнитурах VR, работающих на настольном ПК, где 24-разрядные буферы глубины меньше влияют на производительность.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-143">This preference can be different on VR headsets running on a Desktop PC, where 24-bit depth buffers have less of a performance impact.</span></span>
  
<span data-ttu-id="7fcbf-144">**Предупреждение о производительности:** Использование формата, отличного от основного цвета имеющуюся цепочку буферов, приведет к последующей обработке во время выполнения, что приводит к значительному снижению производительности.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-144">**Performance Warning:** Using a format other than the primary swapchain color format will result in runtime post-processing which comes at a significant performance penalty.</span></span>

### <a name="render-with-recommended-rendering-parameters-and-frame-timing"></a><span data-ttu-id="7fcbf-145">Подготовка к просмотру с рекомендуемыми параметрами отрисовки и временем кадров</span><span class="sxs-lookup"><span data-stu-id="7fcbf-145">Render with recommended rendering parameters and frame timing</span></span>

<span data-ttu-id="7fcbf-146">Всегда отображается с рекомендуемой шириной или высотой конфигурации представления ( `recommendedImageRectWidth` и `recommendedImageRectHeight` из `XrViewConfigurationView` ) и всегда используйте `xrLocateViews` API для запроса рекомендуемых представлений фов и других параметров отрисовки перед отрисовкой.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-146">Always render with the recommended view configuration width/height (`recommendedImageRectWidth` and `recommendedImageRectHeight` from `XrViewConfigurationView`), and always use `xrLocateViews` API to query for the recommended view pose, fov, and other rendering parameters before rendering.</span></span>
<span data-ttu-id="7fcbf-147">Всегда используйте `XrFrameEndInfo.predictedDisplayTime` из последнего `xrWaitFrame` вызова при запросе представлений и объектов.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-147">Always use the `XrFrameEndInfo.predictedDisplayTime` from the latest `xrWaitFrame` call when querying for poses and views.</span></span>
<span data-ttu-id="7fcbf-148">Это позволит HoloLens настроить визуализацию и оптимизировать визуальное качество для пользователя, людьми HoloLens.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-148">This allows HoloLens to adjust rendering and optimize visual quality for the person who is wearing the HoloLens.</span></span>

### <a name="use-a-single-projection-layer"></a><span data-ttu-id="7fcbf-149">Использование одного слоя проекции</span><span class="sxs-lookup"><span data-stu-id="7fcbf-149">Use a single projection layer</span></span>

<span data-ttu-id="7fcbf-150">HoloLens 2 имеет ограниченную мощность GPU для приложений для отрисовки содержимого и аппаратного компоновщика, оптимизированного для одного уровня проекции.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-150">HoloLens 2 has limited GPU power for applications to render content and a hardware compositor optimized for a single projection layer.</span></span>
<span data-ttu-id="7fcbf-151">Всегда использование одного уровня проекции может помочь снизить частоту работы приложения, голограмму и качество визуального элемента.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-151">Always using a single projection layer can help the application's framerate, hologram stability and visual quality.</span></span>  
  
<span data-ttu-id="7fcbf-152">**Предупреждение о производительности:** Передача любого, но одного уровня защиты приведет к последующей обработке во время выполнения, что значительно снижает производительность.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-152">**Performance Warning:** Submitting anything but a single protection layer will result in runtime post-processing which comes at a significant performance penalty.</span></span>

### <a name="render-with-texture-array-and-vprt"></a><span data-ttu-id="7fcbf-153">Отрисовка с помощью массива текстур и ВПРТ</span><span class="sxs-lookup"><span data-stu-id="7fcbf-153">Render with texture array and VPRT</span></span>

<span data-ttu-id="7fcbf-154">Создайте его `xrSwapchain` как для левого, так и для правого глаз `arraySize=2` , используя для имеющуюся цепочку буферов Color, а для глубины — один.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-154">Create one `xrSwapchain` for both left and right eye using `arraySize=2` for color swapchain, and one for depth.</span></span>
<span data-ttu-id="7fcbf-155">Просматривайте левый глаз в срезе 0 и вправо на срез 1.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-155">Render the left eye into slice 0 and the right eye into slice 1.</span></span>
<span data-ttu-id="7fcbf-156">Используйте шейдер с ВПРТ и экземплярными вызовами Draw для отрисовки стереоскопик, чтобы избежать загрузки GPU.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-156">Use a shader with VPRT and instanced draw calls for stereoscopic rendering to minimize GPU load.</span></span>
<span data-ttu-id="7fcbf-157">Это также позволяет оптимизировать среду выполнения для достижения наилучшей производительности в HoloLens 2.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-157">This also enables the runtime's optimization to achieve the best performance on HoloLens 2.</span></span>
<span data-ttu-id="7fcbf-158">Альтернативы использованию массива текстур, такого как отрисовка на уровне Double или отдельная имеющуюся цепочку буферов на глаз, приводят к последующей обработке во время выполнения, что значительно снижает производительность.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-158">Alternatives to using a texture array, such as double-wide rendering or a separate swapchain per eye, will result in runtime post-processing which comes at a significant performance penalty.</span></span>

### <a name="avoid-quad-layers"></a><span data-ttu-id="7fcbf-159">Избегайте использования четырех уровней</span><span class="sxs-lookup"><span data-stu-id="7fcbf-159">Avoid quad layers</span></span>

<span data-ttu-id="7fcbf-160">Вместо того чтобы отправлять четыре слоя в качестве слоев композиции с `XrCompositionLayerQuad` , выводите это содержимое непосредственно в имеющуюся цепочку буферов проекции.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-160">Rather than submitting quad layers as composition layers with `XrCompositionLayerQuad`, render the quad content directly into the projection swapchain.</span></span>

<span data-ttu-id="7fcbf-161">**Предупреждение о производительности:** Предоставление дополнительных слоев за пределами одного слоя проекции, например четырех слоев, приведет к последующей обработке во время выполнения, что значительно снижает производительность.</span><span class="sxs-lookup"><span data-stu-id="7fcbf-161">**Performance Warning:** Providing additional layers beyond a single projection layer, such as quad layers, will result in runtime post-processing which comes at a significant performance penalty.</span></span>